{# templates/partials/ledger_row.html #}
{% with has_so=row.so_id|default_if_none:False has_po=row.po_id|default_if_none:False %}
<tr class="group hover:bg-gradient-to-r hover:from-gray-50 hover:to-blue-50 transition-all duration-200">
  {# Date Column #}
  <td class="px-6 py-4 whitespace-nowrap text-sm">
    <div class="flex items-center gap-2">
      <svg class="w-4 h-4 text-gray-400 group-hover:text-indigo-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <span class="font-medium text-gray-900">{{ row.date|date:"M d, Y" }}</span>
    </div>
  </td>

  {# Reference Column #}
  <td class="px-6 py-4 text-sm">
    <div class="flex items-center gap-2 flex-wrap">
      <span class="font-semibold text-indigo-600">{{ row.ref }}</span>
      
      {% if all_mode %}
        <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-full border border-gray-200">
          {{ row.biz_name }}
        </span>
      {% endif %}
      
      {% if has_so and row.so_item_count %}
        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-800 rounded-full">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3z"/>
          </svg>
          {{ row.so_item_count }} items
        </span>
      {% endif %}
      
      {% if has_po and row.po_item_count %}
        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-sky-100 text-sky-800 rounded-full">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4z" clip-rule="evenodd"/>
          </svg>
          {{ row.po_item_count }} items
        </span>
      {% endif %}

      {% if has_so or has_po %}
        <button type="button"
                class="px-2 py-1 text-xs font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition-colors"
                data-toggle="row-items">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
          Details
        </button>
      {% endif %}
    </div>
  </td>

  {# Description Column #}
  <td class="px-6 py-4 text-sm">
    <div class="space-y-2">
      <p class="text-gray-700">{{ row.note }}</p>
      
      {% if has_so and row.so_net_total %}
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <svg class="w-3 h-3 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
          </svg>
          <span>Order Total: <strong>Rs. {{ row.so_net_total|floatformat:2 }}</strong></span>
          <span class="text-gray-400">|</span>
          <span>Paid: <strong>Rs. {{ row.so_paid|default:"0.00"|floatformat:2 }}</strong></span>
        </div>
      {% endif %}
      
      {% if has_po and row.po_net_total %}
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <svg class="w-3 h-3 text-sky-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
          </svg>
          <span>PO Total: <strong>Rs. {{ row.po_net_total|floatformat:2 }}</strong></span>
          <span class="text-gray-400">|</span>
          <span>Paid: <strong>Rs. {{ row.po_paid|default:"0.00"|floatformat:2 }}</strong></span>
        </div>
      {% endif %}
    </div>
  </td>

  {# Debit Column #}
  <td class="px-6 py-4 text-right text-sm font-semibold whitespace-nowrap">
    {% if row.dr %}
      <div class="flex items-center justify-end gap-2">
        <span class="text-blue-700">Rs. {{ row.dr|floatformat:2 }}</span>
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
      </div>
    {% else %}
      <span class="text-gray-300">—</span>
    {% endif %}
  </td>

  {# Credit Column #}
  <td class="px-6 py-4 text-right text-sm font-semibold whitespace-nowrap">
    {% if row.cr %}
      <div class="flex items-center justify-end gap-2">
        <span class="text-emerald-700">Rs. {{ row.cr|floatformat:2 }}</span>
        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
      </div>
    {% else %}
      <span class="text-gray-300">—</span>
    {% endif %}
  </td>

  {# Running Balance Column #}
  <td class="px-6 py-4 text-right text-sm font-bold whitespace-nowrap">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-lg
                {% if row.run_side == 'Dr' %}bg-blue-50 text-blue-800 border border-blue-200
                {% else %}bg-emerald-50 text-emerald-800 border border-emerald-200{% endif %}">
      <span>Rs. {{ row.run_amount|floatformat:2 }}</span>
      <span class="text-xs font-medium px-1.5 py-0.5 rounded 
                   {% if row.run_side == 'Dr' %}bg-blue-600 text-white
                   {% else %}bg-emerald-600 text-white{% endif %}">
        {{ row.run_side }}
      </span>
    </div>
  </td>
</tr>

{# Expandable Details Row #}
{% if has_so or has_po %}
<tr class="hidden bg-gradient-to-r from-gray-50 to-blue-50" data-items-row>
  <td colspan="6" class="px-6 py-4">
    <div class="space-y-4">
      
      {# Sales Order Items #}
      {% if has_so and row.so_items %}
        <div class="bg-white rounded-lg border border-emerald-200 overflow-hidden">
          <div class="bg-gradient-to-r from-emerald-500 to-green-600 px-4 py-2">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
              </svg>
              Sales Order #{{ row.so_id }} - Items Detail
            </h3>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-emerald-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-emerald-700 uppercase">Product</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-emerald-700 uppercase">Quantity</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-emerald-700 uppercase">Unit Price</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-emerald-700 uppercase">Line Total</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for it in row.so_items %}
                  <tr class="hover:bg-emerald-50 transition-colors">
                    <td class="px-4 py-2 text-sm text-gray-900 font-medium">
                      <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                        {{ it.product }}
                      </div>
                    </td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">{{ it.qty }} {% if it.unit_code %}{{ it.unit_code }}{% endif %}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">Rs. {{ it.unit_price|floatformat:2 }}{% if it.unit_code %} / {{ it.unit_code }}{% endif %}</td>
                    <td class="px-4 py-2 text-sm font-semibold text-emerald-700 text-right">Rs. {{ it.line_total|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot class="bg-emerald-100">
                <tr>
                  <td colspan="3" class="px-4 py-2 text-sm font-medium text-emerald-800 text-right">Net Total:</td>
                  <td class="px-4 py-2 text-sm font-bold text-emerald-900 text-right">Rs. {{ row.so_net_total|floatformat:2 }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      {% endif %}

      {# Purchase Order Items #}
      {% if has_po and row.po_items %}
        <div class="bg-white rounded-lg border border-sky-200 overflow-hidden">
          <div class="bg-gradient-to-r from-sky-500 to-blue-600 px-4 py-2">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Purchase Order #{{ row.po_id }} - Items Detail
            </h3>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-sky-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-sky-700 uppercase">Product</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-sky-700 uppercase">Quantity</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-sky-700 uppercase">Unit Price</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-sky-700 uppercase">Line Total</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for it in row.po_items %}
                  <tr class="hover:bg-sky-50 transition-colors">
                    <td class="px-4 py-2 text-sm text-gray-900 font-medium">
                      <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-sky-400 rounded-full"></div>
                        {{ it.product }}
                      </div>
                    </td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">{{ it.qty }} {% if it.unit_code %}{{ it.unit_code }}{% endif %}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">Rs. {{ it.unit_price|floatformat:2 }}{% if it.unit_code %} / {{ it.unit_code }}{% endif %}</td>
                    <td class="px-4 py-2 text-sm font-semibold text-sky-700 text-right">Rs. {{ it.line_total|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot class="bg-sky-100">
                <tr>
                  <td colspan="3" class="px-4 py-2 text-sm font-medium text-sky-800 text-right">Net Total:</td>
                  <td class="px-4 py-2 text-sm font-bold text-sky-900 text-right">Rs. {{ row.po_net_total|floatformat:2 }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      {% endif %}
      
    </div>
  </td>
</tr>
{% endif %}
{% endwith %}
