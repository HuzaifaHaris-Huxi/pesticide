{# templates/barkat/parties/business_customer.html #} {% extends "base.html" %}
{% load static %} {% block content %}
<div class="p-4 md:p-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i data-feather="user" class="w-7 h-7"></i>
      <span>Customers — {{ business.name }}</span>
    </h1>

    <div class="flex items-center gap-2">
      <a
        href="{% if business %}{% url 'party_create' %}?business={{ business.id }}&type=customer&next={% url 'business_customers' business.id %}{% else %}{% url 'party_create' %}?type=customer{% endif %}"
        class="rounded-lg px-3 py-2 bg-slate-900 text-white hover:bg-slate-800"
      >
        + New Customer
      </a>
    </div>
  </div>

  {# Quick business switch (colored links) #}
  <div class="mb-3">
    <div class="flex gap-2 overflow-x-auto pb-1 border-b border-slate-300">
      {# All Button #} {% if not business %}
      <a
        href="{% url 'customers_list' %}"
        aria-current="page"
        data-tint="slate"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium transition-all duration-300 bg-slate-700 text-white border-slate-700 shadow-md"
      >
        All
      </a>
      {% else %}
      <a
        href="{% url 'customers_list' %}"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium transition-all duration-300 text-slate-600 border-slate-300 hover:bg-slate-200"
      >
        All
      </a>
      {% endif %} {# Business Buttons #}
      <!--HTML-->
      {% for b in businesses %}
      <span class="hidden"
        >{% cycle 'indigo' 'emerald' 'rose' 'amber' as color %}</span
      >

      {% if business and business.id == b.id %}
      <a
        href="{% url 'business_customers' b.id %}"
        aria-current="page"
        data-tint="{{ color }}"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium transition-all duration-300
                    bg-{{ color }}-700 text-white border-{{ color }}-700 shadow-md"
      >
        {{ b.name }}
      </a>
      {% else %}
      <a
        href="{% url 'business_customers' b.id %}"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium transition-all duration-300
                    text-{{ color }}-700 border-{{ color }}-300 hover:bg-{{ color }}-100 hover:border-{{ color }}-600 hover:text-{{ color }}-900"
      >
        {{ b.name }}
      </a>
      {% endif %} {% endfor %}
    </div>
  </div>

  {# Controls: Search on keypress + page size #}
  <div
    class="mb-3 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between"
  >
    <div class="flex items-center gap-2">
      <label for="bizCustSearch" class="text-sm text-slate-600">Search:</label>
      <input
        id="bizCustSearch"
        type="search"
        placeholder="Type to filter…"
        class="w-64 max-w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm"
        autocomplete="off"
      />
    </div>
    <div class="flex items-center gap-2">
      <label for="bizCustPerPage" class="text-sm text-slate-600">Show</label>
      <select
        id="bizCustPerPage"
        class="rounded-lg border border-slate-300 bg-white px-2 py-2 text-sm"
      >
        <option value="10">10</option>
        <option value="25" selected>25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span class="text-sm text-slate-600">entries</span>
    </div>
  </div>

  {# Table (plain HTML) #}
  <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-4 py-2 text-left">ID</th>
          <th class="px-4 py-2 text-left">Display Name</th>
          <th class="px-4 py-2 text-left">Phone</th>
          <th class="px-4 py-2 text-left">Email</th>
          <th class="px-4 py-2 text-left">Active</th>
          <th class="px-4 py-2 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="bizCustomersBody">
        {% for c in customers %}
        <tr class="border-t">
          <td class="px-4 py-2">{{ c.id }}</td>
          <td class="px-4 py-2">{{ c.display_name }}</td>
          <td class="px-4 py-2">{{ c.phone }}</td>
          <td class="px-4 py-2">{{ c.email }}</td>
          <td class="px-4 py-2">
            {% if c.is_active %}
            <span
              class="inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-emerald-50 text-emerald-700 border border-emerald-200"
            >
              Active
            </span>
            {% else %}
            <span
              class="inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700 border border-slate-200"
            >
              Inactive
            </span>
            {% endif %}
          </td>
            <td class="px-4 py-2 text-right whitespace-nowrap">
              <a
                href="{% url 'party_detail' c.id %}"
                class="inline-flex items-center gap-1 rounded-md border border-slate-300 px-2 py-1 text-xs hover:bg-slate-50"
              >
                View
              </a>
              <a
                href="{% url 'party_update' c.id %}"
                class="inline-flex items-center gap-1 rounded-md border border-indigo-300 text-indigo-700 px-2 py-1 text-xs hover:bg-indigo-50 ml-1"
              >
                Edit
              </a>

              <form
                action="{% url 'party_delete' c.id %}"
                method="post"
                class="inline ml-1"
                onsubmit="return confirm('Delete this customer permanently?');"
              >
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button
                  type="submit"
                  class="inline-flex items-center gap-1 rounded-md border border-rose-300 text-rose-700 px-2 py-1 text-xs hover:bg-rose-50"
                  title="Delete"
                >
                  Delete
                </button>
              </form>
            </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-6 text-center text-slate-500">
            No customers for {{ business.name }}.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Pagination #}
  <div
    class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
  >
    <div id="bizCustInfo" class="text-sm text-slate-600">
      Showing 0 to 0 of 0
    </div>
    <div class="flex items-center gap-1">
      <button
        id="bizCustFirst"
        class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
      >
        First
      </button>
      <button
        id="bizCustPrev"
        class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
      >
        Prev
      </button>
      <span id="bizCustPage" class="px-3 py-1 text-sm text-slate-700"
        >Page 1 / 1</span
      >
      <button
        id="bizCustNext"
        class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
      >
        Next
      </button>
      <button
        id="bizCustLast"
        class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
      >
        Last
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block all_scripts %}
<script>
  (function () {
    // Elements
    const tbody = document.getElementById("bizCustomersBody");
    const rowsAll = Array.from(tbody.querySelectorAll("tr"));
    const inpSearch = document.getElementById("bizCustSearch");
    const selPerPage = document.getElementById("bizCustPerPage");

    const btnFirst = document.getElementById("bizCustFirst");
    const btnPrev = document.getElementById("bizCustPrev");
    const btnNext = document.getElementById("bizCustNext");
    const btnLast = document.getElementById("bizCustLast");
    const lblPage = document.getElementById("bizCustPage");
    const lblInfo = document.getElementById("bizCustInfo");

    // --- Apply lighter background tint for active tab ---
    const activeTab = document.querySelector(
      '[aria-current="page"][data-tint]'
    );
    const tint = activeTab ? activeTab.getAttribute("data-tint") : "slate";
    const tintMap = {
      indigo: "bg-indigo-200",
      emerald: "bg-emerald-200",
      rose: "bg-rose-200",
      amber: "bg-amber-200",
      slate: "bg-slate-200",
    };
    const tintClasses = Object.values(tintMap);
    tbody.classList.remove(...tintClasses);
    tbody.classList.add(tintMap[tint] || "bg-slate-50");

    // Pagination logic
    let searchTerm = "";
    let perPage = parseInt(selPerPage.value, 10) || 25;
    let page = 1; // 1-based

    function norm(s) {
      return (s || "").toString().toLowerCase();
    }

    function matchesRow(tr, term) {
      if (!term) return true;
      const t = norm(term);
      const cells = tr.children;
      for (let i = 0; i < Math.min(5, cells.length); i++) {
        if (norm(cells[i].textContent).includes(t)) return true;
      }
      return false;
    }

    function filteredRows() {
      return rowsAll.filter((tr) => matchesRow(tr, searchTerm));
    }

    function totalPages(total) {
      return Math.max(1, Math.ceil(total / perPage));
    }

    function clampPage(p, pages) {
      return Math.min(Math.max(1, p), pages);
    }

    function render() {
      const items = filteredRows();
      const total = items.length;
      const pages = totalPages(total);
      page = clampPage(page, pages);

      const startIdx = (page - 1) * perPage;
      const endIdx = Math.min(startIdx + perPage, total);
      const slice = items.slice(startIdx, endIdx);

      tbody.innerHTML = "";
      if (slice.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="px-4 py-6 text-center text-slate-500">No customers for {{ business.name }}.</td>`;
        tbody.appendChild(tr);
      } else {
        slice.forEach((tr) => tbody.appendChild(tr));
      }

      lblPage.textContent = `Page ${page} / ${pages}`;
      const showingFrom = total === 0 ? 0 : startIdx + 1;
      const showingTo = total === 0 ? 0 : endIdx;
      lblInfo.textContent = `Showing ${showingFrom} to ${showingTo} of ${total}`;

      btnFirst.disabled = page <= 1;
      btnPrev.disabled = page <= 1;
      btnNext.disabled = page >= pages;
      btnLast.disabled = page >= pages;
      [btnFirst, btnPrev, btnNext, btnLast].forEach((b) => {
        b.classList.toggle("opacity-50", b.disabled);
        b.classList.toggle("cursor-not-allowed", b.disabled);
      });
    }

    inpSearch.addEventListener("input", (e) => {
      searchTerm = e.target.value || "";
      page = 1;
      render();
    });

    selPerPage.addEventListener("change", (e) => {
      perPage = parseInt(e.target.value, 10) || 25;
      page = 1;
      render();
    });

    btnFirst.addEventListener("click", () => {
      page = 1;
      render();
    });
    btnPrev.addEventListener("click", () => {
      page = Math.max(1, page - 1);
      render();
    });
    btnNext.addEventListener("click", () => {
      page = page + 1;
      render();
    });
    btnLast.addEventListener("click", () => {
      const pages = totalPages(filteredRows().length);
      page = pages;
      render();
    });

    render();
  })();
</script>
{% endblock %}
