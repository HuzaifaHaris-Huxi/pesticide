{# templates/barkat/purchases/purchase_order_list.html #}
{% extends "base.html"%}
{% load static %}
{% block content %}
<div class="p-4 md:p-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i data-feather="shopping-cart" class="w-7 h-7"></i>
      <span>Purchase Orders</span>
    </h1>
  </div>

  {# Business tabs #}
  <div class="mb-3">
    <div class="flex gap-2 overflow-x-auto pb-1 border-b border-slate-300">
      {# All #}
      <a
        href="{% url 'po_list' %}"
        aria-current="page"
        data-tint="slate"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium bg-slate-700 text-white border-slate-700 shadow-md"
      >
        All
      </a>
      {# Businesses #}
      {% for b in businesses %}
        <span class="hidden">{% cycle 'indigo' 'emerald' 'rose' 'amber' as color %}</span>
        <a
          href="{% url 'po_list_business' b.id %}"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium
                 text-{{ color }}-700 border-{{ color }}-300 hover:bg-{{ color }}-100 hover:border-{{ color }}-600 hover:text-{{ color }}-900"
        >
          {{ b.name }}
        </a>
      {% endfor %}
    </div>
  </div>

  {# Filters #}
  <form method="get" class="mb-4 flex flex-wrap items-end gap-3" id="po-filter-form">
    <div>
      <label class="block text-xs text-slate-600 mb-1">Search</label>
      <input
        name="q"
        value="{{ q }}"
        type="search"
        placeholder="Search vendor, status, id…"
        class="w-64 max-w-full rounded-lg border border-slate-300 bg-white px-3 py-2"
      />
    </div>

    <div>
      <label class="block text-xs text-slate-600 mb-1">From date</label>
      <input
        type="date"
        name="from"
        value="{{ date_from }}"
        class="rounded-lg border border-slate-300 bg-white px-3 py-2"
      />
    </div>

    <div>
      <label class="block text-xs text-slate-600 mb-1">To date</label>
      <input
        type="date"
        name="to"
        value="{{ date_to }}"
        class="rounded-lg border border-slate-300 bg-white px-3 py-2"
      />
    </div>

    <div class="flex flex-col gap-1">
      <span class="block text-xs text-slate-600 mb-1">Quick ranges</span>
      <div class="flex flex-wrap gap-1">
        <button
          type="button"
          class="px-2 py-1 rounded-full border text-xs border-slate-300 text-slate-700 hover:bg-slate-100 js-range-btn"
          data-range="today"
        >
          Today
        </button>
        <button
          type="button"
          class="px-2 py-1 rounded-full border text-xs border-slate-300 text-slate-700 hover:bg-slate-100 js-range-btn"
          data-range="yesterday"
        >
          Yesterday
        </button>
        <button
          type="button"
          class="px-2 py-1 rounded-full border text-xs border-slate-300 text-slate-700 hover:bg-slate-100 js-range-btn"
          data-range="week"
        >
          This week
        </button>
        <button
          type="button"
          class="px-2 py-1 rounded-full border text-xs border-slate-300 text-slate-700 hover:bg-slate-100 js-range-btn"
          data-range="month"
        >
          This month
        </button>
        <button
          type="button"
          class="px-2 py-1 rounded-full border text-xs border-slate-300 text-slate-700 hover:bg-slate-100 js-range-btn"
          data-range="year"
        >
          This year
        </button>
      </div>
    </div>

    <div class="flex items-end gap-2">
      <button
        class="rounded-lg px-3 py-2 bg-slate-900 text-white hover:bg-slate-800"
      >
        Filter
      </button>
      <a
        href="{% url 'po_list' %}"
        class="rounded-lg px-3 py-2 border border-slate-300 hover:bg-slate-50"
      >
        Reset
      </a>
    </div>
  </form>

  {# Summary cards #}
  {% if totals %}
    <div class="mb-4 grid gap-3 md:grid-cols-4">
      <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
        <div class="text-xs font-semibold text-slate-500 uppercase">
          Subtotal
        </div>
        <div class="mt-1 text-lg font-semibold">
          ₨ {{ totals.total_subtotal|floatformat:2 }}
        </div>
        <div class="text-[11px] text-slate-500 mt-1">
          Sum of item totals before tax and discount
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
        <div class="text-xs font-semibold text-slate-500 uppercase">
          Net total
        </div>
        <div class="mt-1 text-lg font-semibold">
          ₨ {{ totals.total_net|floatformat:2 }}
        </div>
        <div class="text-[11px] text-slate-500 mt-1">
          After tax and discount
        </div>
      </div>

      <div class="rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 shadow-sm">
        <div class="text-xs font-semibold text-emerald-700 uppercase">
          Paid
        </div>
        <div class="mt-1 text-lg font-semibold text-emerald-700">
          ₨ {{ totals.total_paid|floatformat:2 }}
        </div>
        <div class="text-[11px] text-emerald-700 mt-1">
          Total amount paid to suppliers
        </div>
      </div>

      <div class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 shadow-sm">
        <div class="text-xs font-semibold text-amber-700 uppercase">
          Remaining
        </div>
        <div class="mt-1 text-lg font-semibold text-amber-700">
          ₨ {{ totals.total_remaining|floatformat:2 }}
        </div>
        <div class="text-[11px] text-amber-700 mt-1">
          Outstanding payable balance
        </div>
      </div>
    </div>
  {% endif %}

  <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-4 py-2 text-left">PO #</th>
          <th class="px-4 py-2 text-left">Date</th>
          <th class="px-4 py-2 text-left">Business</th>
          <th class="px-4 py-2 text-left">Vendor</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-right">Subtotal</th>
          <th class="px-4 py-2 text-right">Tax %</th>
          <th class="px-4 py-2 text-right">Discount %</th>
          <th class="px-4 py-2 text-right">Net Total</th>
          <th class="px-4 py-2 text-right">Paid</th>
          <th class="px-4 py-2 text-right">Remaining</th>
          <th class="px-4 py-2 text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for po in orders %}
          <tr class="border-t">
            <td class="px-4 py-2">#{{ po.id }}</td>
            <td class="px-4 py-2">{{ po.created_at|date:"Y-m-d" }}</td>
            <td class="px-4 py-2">{{ po.business.name }}</td>
            <td class="px-4 py-2">{{ po.supplier.display_name }}</td>
            <td class="px-4 py-2">
              {{ po.get_status_display|default:po.status }}
            </td>
            <td class="px-4 py-2 text-right">
              ₨ {{ po.annotated_subtotal|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right">
              {{ po.tax_percent|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right">
              {{ po.discount_percent|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right font-semibold">
              ₨ {{ po.annotated_net_total|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right text-emerald-700">
              ₨ {{ po.paid_amount|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right text-amber-700">
              ₨ {{ po.remaining|floatformat:2 }}
            </td>
            <td class="px-4 py-2 text-right whitespace-nowrap">
              <a
                href="{% url 'po_edit' po.pk %}"
                class="inline-flex items-center gap-1 rounded-md border border-indigo-300 text-indigo-700 px-2 py-1 text-xs hover:bg-indigo-50"
              >
                Edit
              </a>
              <a
                href="{% url 'po_delete' po.pk %}"
                class="inline-flex items-center gap-1 rounded-md border border-rose-300 text-rose-700 px-2 py-1 text-xs hover:bg-rose-50 ml-1"
              >
                Delete
              </a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="12" class="px-4 py-6 text-center text-slate-500">
              No purchase orders found.
            </td>
          </tr>
        {% endfor %}
      </tbody>

      {% if orders %}
      <tfoot class="bg-slate-50 border-t">
        <tr>
          <td colspan="5" class="px-4 py-2 text-right font-semibold">
            Totals
          </td>
          <td class="px-4 py-2 text-right font-semibold">
            ₨ {{ totals.total_subtotal|floatformat:2 }}
          </td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2"></td>
          <td class="px-4 py-2 text-right font-semibold">
            ₨ {{ totals.total_net|floatformat:2 }}
          </td>
          <td class="px-4 py-2 text-right font-semibold text-emerald-700">
            ₨ {{ totals.total_paid|floatformat:2 }}
          </td>
          <td class="px-4 py-2 text-right font-semibold text-amber-700">
            ₨ {{ totals.total_remaining|floatformat:2 }}
          </td>
          <td class="px-4 py-2"></td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</div>
{% endblock %}

{% block all_scripts %}
<script>
  // Quick date range buttons . Today, Yesterday, This week, This month, This year
  (function () {
    const form = document.getElementById("po-filter-form");
    if (!form) return;

    const fromInput = form.querySelector('input[name="from"]');
    const toInput = form.querySelector('input[name="to"]');
    const buttons = form.querySelectorAll(".js-range-btn");

    if (!fromInput || !toInput || !buttons.length) return;

    function fmt(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function setRange(range) {
      const now = new Date();
      let start = new Date(now);
      let end = new Date(now);

      if (range === "today") {
        // already today
      } else if (range === "yesterday") {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
      } else if (range === "week") {
        const day = now.getDay(); // 0..6, treat Monday as start
        const diffToMonday = (day + 6) % 7;
        start.setDate(now.getDate() - diffToMonday);
      } else if (range === "month") {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
      } else if (range === "year") {
        start = new Date(now.getFullYear(), 0, 1);
      }

      fromInput.value = fmt(start);
      toInput.value = fmt(end);
      form.submit();
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const range = this.getAttribute("data-range");
        if (range) {
          setRange(range);
        }
      });
    });
  })();
</script>
{% endblock %}
