{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto mt-6 px-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Quick Receipts</h2>
    <a href="{% url 'quick_receipt_create' %}"
       class="inline-flex items-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">
      + New Receipt
    </a>
  </div>

  {# main filter form #}
  <form method="get" class="mb-2 bg-white border border-slate-200 rounded-xl p-3 grid grid-cols-1 md:grid-cols-4 gap-3">
    <div>
      <label class="block text-xs font-medium text-slate-600 mb-1">Search</label>
      <input type="text" name="q" value="{{ q }}"
             class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm"
             placeholder="Customer, ref, note, amount">
    </div>
    <div>
      <label class="block text-xs font-medium text-slate-600 mb-1">Date from</label>
      <input type="date" name="date_from" value="{{ date_from }}"
             class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm">
    </div>
    <div>
      <label class="block text-xs font-medium text-slate-600 mb-1">Date to</label>
      <input type="date" name="date_to" value="{{ date_to }}"
             class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm">
    </div>
    <div class="flex items-end">
      <button type="submit"
              class="w-full rounded-lg bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">
        Filter
      </button>
    </div>
  </form>

  {# quick date filters and pending cheques toggle #}
  <div class="mb-4 flex flex-wrap items-center gap-2 text-xs md:text-sm">
    <span class="text-slate-600 mr-1">Quick range.</span>

    <a href="?period=today&q={{ q|urlencode }}{% if pending_only %}&pending=1{% endif %}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if period == 'today' %}bg-slate-900 text-white border-slate-900
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      Today
    </a>

    <a href="?period=yesterday&q={{ q|urlencode }}{% if pending_only %}&pending=1{% endif %}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if period == 'yesterday' %}bg-slate-900 text-white border-slate-900
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      Yesterday
    </a>

    <a href="?period=month&q={{ q|urlencode }}{% if pending_only %}&pending=1{% endif %}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if period == 'month' %}bg-slate-900 text-white border-slate-900
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      This month
    </a>

    <a href="?period=year&q={{ q|urlencode }}{% if pending_only %}&pending=1{% endif %}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if period == 'year' %}bg-slate-900 text-white border-slate-900
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      This year
    </a>

    <a href="?q={{ q|urlencode }}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if not period and not date_from and not date_to %}bg-slate-900 text-white border-slate-900
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      Clear range
    </a>

    <span class="ml-auto"></span>

    <a href="?pending=1&q={{ q|urlencode }}{% if period %}&period={{ period }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
       class="px-3 py-1 rounded-full border text-xs md:text-sm
              {% if pending_only %}bg-orange-600 text-white border-orange-600
              {% else %}bg-white text-slate-700 border-slate-300 hover:bg-slate-50{% endif %}">
      Pending cheques only
    </a>
  </div>

  <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">

    <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
    <div class="bg-white border border-slate-200 rounded-xl px-3 py-2">
      <div class="text-xs text-slate-500">Cash Received</div>
      <div class="text-base font-semibold">{{ cash_total }}</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl px-3 py-2">
      <div class="text-xs text-slate-500">Bank Received</div>
      <div class="text-base font-semibold">{{ bank_total }}</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl px-3 py-2">
      <div class="text-xs text-slate-500">Pending Cheques</div>
      <div class="text-base font-semibold text-amber-700">{{ pending_total }}</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-xl px-3 py-2">
      <div class="text-xs text-slate-500">Total Received (Cash + Bank)</div>
      <div class="text-base font-semibold text-emerald-700">{{ total_received }}</div>
    </div>
  </div>


    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 border-b border-slate-200">
          <tr class="text-left text-xs font-semibold text-slate-600">
            <th class="px-3 py-2">Date</th>
            <th class="px-3 py-2">Business</th>
            <th class="px-3 py-2">Customer or Vendor</th>
            <th class="px-3 py-2">Type</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2">Bank or Ref</th>
            <th class="px-3 py-2">Note</th>
            <th class="px-3 py-2 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if receipts %}
            {% for r in receipts %}
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-3 py-2 align-top">
                  {{ r.date|date:"Y-m-d" }}
                </td>
                <td class="px-3 py-2 align-top">
                  {{ r.business.code }}
                </td>
                <td class="px-3 py-2 align-top">
                  {{ r.party.display_name }}
                </td>
                <td class="px-3 py-2 align-top">
                  {% if r.payment_method %}
                    {{ r.get_payment_method_display }}
                  {% else %}
                    {{ r.get_payment_source_display }}
                  {% endif %}
                </td>
                <td class="px-3 py-2 align-top text-xs text-slate-700">
                  {% if r.payment_method == 'cheque' %}
                    {{ r.get_cheque_status_display }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="px-3 py-2 align-top text-right font-semibold">
                  {{ r.amount }}
                </td>
                <td class="px-3 py-2 align-top text-xs text-slate-600">
                  {% if r.bank_account %}
                    Bank. {{ r.bank_account.name }}<br>
                  {% endif %}
                  {% if r.reference %}
                    Ref. {{ r.reference }}
                  {% endif %}
                </td>
                <td class="px-3 py-2 align-top text-xs text-slate-600 max-w-xs">
                  {{ r.description|default:"" }}
                </td>
                <td class="px-3 py-2 align-top text-right">
                  <div class="flex items-center justify-end gap-2">
                    <a href="{% url 'quick_receipt_edit' r.pk %}"
                      class="inline-flex items-center rounded-md border border-slate-300 px-2 py-1 text-xs text-slate-700 hover:bg-slate-50 transition-colors">
                      Edit
                    </a>

                    <button type="button" 
                            data-receipt-id="{{ r.pk }}"
                            class="delete-receipt-btn inline-flex items-center rounded-md border border-red-200 bg-red-50 px-2 py-1 text-xs text-red-600 hover:bg-red-100 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="px-3 py-4 text-center text-sm text-slate-500">
                No receipts found.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="px-3 py-2 border-t border-slate-200 flex items-center justify-between text-xs text-slate-600">
        <div>
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </div>
        <div class="space-x-1">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&date_from={{ date_from }}&date_to={{ date_to }}{% if period %}&period={{ period }}{% endif %}{% if pending_only %}&pending=1{% endif %}"
               class="px-2 py-1 rounded border border-slate-300 bg-white hover:bg-slate-50">
              Previous
            </a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&date_from={{ date_from }}&date_to={{ date_to }}{% if period %}&period={{ period }}{% endif %}{% if pending_only %}&pending=1{% endif %}"
               class="px-2 py-1 rounded border border-slate-300 bg-white hover:bg-slate-50">
              Next
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Password Modal for Delete Confirmation -->
<div id="deletePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b border-slate-200">
      <h3 class="text-lg font-semibold text-slate-900">Delete Receipt</h3>
    </div>
    <form id="deleteReceiptForm" method="post" action="">
      {% csrf_token %}
      <div class="px-6 py-4">
        <p class="text-sm text-slate-600 mb-4">
          Are you sure you want to permanently delete this receipt? This will also remove the entry from your cash ledger.
        </p>
        <div>
          <label for="deletePassword" class="block text-sm font-medium text-slate-700 mb-2">
            Enter Cancellation Password
          </label>
          <input type="password" 
                 id="deletePassword" 
                 name="cancellation_password"
                 class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                 placeholder="Enter password"
                 required>
          <p class="text-xs text-slate-500 mt-1">
            This is your cancellation password from User Settings
          </p>
        </div>
      </div>
      <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-2">
        <button type="button" 
                id="cancelDeleteBtn"
                class="px-4 py-2 rounded-lg border border-slate-300 text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors">
          Cancel
        </button>
        <button type="submit"
                class="px-4 py-2 rounded-lg bg-red-600 text-sm font-medium text-white hover:bg-red-700 transition-colors">
          Delete Receipt
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('deletePasswordModal');
  const form = document.getElementById('deleteReceiptForm');
  const passwordInput = document.getElementById('deletePassword');
  const cancelBtn = document.getElementById('cancelDeleteBtn');
  const deleteButtons = document.querySelectorAll('.delete-receipt-btn');

  // Open modal when delete button is clicked
  deleteButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const receiptId = this.getAttribute('data-receipt-id');
      form.action = `/finance/receipts/${receiptId}/delete/`;
      passwordInput.value = '';
      modal.classList.remove('hidden');
      passwordInput.focus();
    });
  });

  // Close modal on cancel
  cancelBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
    passwordInput.value = '';
  });

  // Close modal on background click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.classList.add('hidden');
      passwordInput.value = '';
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      modal.classList.add('hidden');
      passwordInput.value = '';
    }
  });
})();
</script>
{% endblock %}


