{% extends "base.html" %}
{% load static %}
{% block title %}{{ gate_title|default:"Password required" }}{% endblock %}
{% block content %}
<div class="max-w-md mx-auto px-4 py-12">
  <div class="bg-white rounded-xl border border-slate-200 shadow-lg p-6">
    <h1 class="text-xl font-semibold text-slate-800 mb-2">{{ gate_title|default:"Password required" }}</h1>
    <p class="text-sm text-slate-600 mb-4">{{ gate_message|default:"Enter your cancellation password (from User Settings) to continue." }}</p>
    
    {% if use_post %}
    {# Direct POST to the same URL for one-time verification #}
    <form method="post" action="{{ next_url }}" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="gatePassword" class="block text-sm font-medium text-slate-700 mb-1">Cancellation password</label>
        <input type="password" id="gatePassword" name="password" autocomplete="off" required
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">Submit</button>
        <a href="{{ cancel_url }}" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">Cancel</a>
      </div>
    </form>
    {% else %}
    {# API-based verification with session #}
    <form id="gateForm" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="gatePassword" class="block text-sm font-medium text-slate-700 mb-1">Cancellation password</label>
        <input type="password" id="gatePassword" name="password" autocomplete="off" required
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:ring-2 focus:ring-blue-500" />
      </div>
      <p id="gateError" class="text-sm text-rose-600 hidden"></p>
      <div class="flex gap-2">
        <button type="submit" id="gateSubmit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">Submit</button>
        <a href="{{ cancel_url }}" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">Cancel</a>
      </div>
    </form>
    <script>
    (function() {
      const form = document.getElementById('gateForm');
      const pass = document.getElementById('gatePassword');
      const err = document.getElementById('gateError');
      const submit = document.getElementById('gateSubmit');
      const nextUrl = "{{ next_url|escapejs }}";
      const action = "{{ action|default:'supplier_ledger'|escapejs }}";

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!pass.value.trim()) { err.textContent = 'Please enter the password.'; err.classList.remove('hidden'); return; }
        err.classList.add('hidden');
        submit.disabled = true;

        const fd = new FormData();
        fd.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        fd.append('password', pass.value);
        fd.append('action', action);

        try {
          const r = await fetch('{% url "verify_cancellation_password_api" %}', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await r.json();
          if (data.ok) {
            window.location.href = nextUrl;
            return;
          }
          err.textContent = data.error || 'Verification failed.';
          err.classList.remove('hidden');
        } catch (e) {
          err.textContent = 'Network error. Please try again.';
          err.classList.remove('hidden');
        } finally {
          submit.disabled = false;
        }
      });
    })();
    </script>
    {% endif %}
  </div>
</div>
{% endblock %}
