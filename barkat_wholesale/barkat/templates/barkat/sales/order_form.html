{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="max-w-[1400px] mx-auto p-4 md:p-6">

  <!-- Header Section -->
  <div class="mb-3">
    <div class="flex flex-col md:flex-row gap-3 justify-between items-start md:items-center mb-2">
      <!-- Title -->
      <h1 class="text-xl md:text-2xl font-bold text-slate-800">
        {% if object %}Edit Order #{{ object.id }}{% else %}New Order{% endif %}
      </h1>
      
      <!-- Action Button -->
      <a href="{% url 'so_list' %}"
         class="inline-flex items-center gap-2 bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded-lg transition-colors text-sm font-medium shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        View Orders
      </a>
    </div>

    <!-- Business tabs -->
    <div class="flex gap-2 overflow-x-auto pb-1 border-b border-slate-300">
      {% for b in businesses %}
        <span class="hidden">{% cycle 'indigo' 'emerald' 'rose' 'amber' as color %}</span>

        {% if business and b.id == business.id %}
          <a
            href="{% url 'so_add' %}?business={{ b.id }}"
            data-business-id="{{ b.id }}"
            data-color="{{ color }}"
            aria-current="page"
            class="biz-tab inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium bg-{{ color }}-700 text-white border-{{ color }}-700 shadow-md">
            {{ b.name }}
          </a>
        {% else %}
          <a
            href="{% url 'so_add' %}?business={{ b.id }}"
            data-business-id="{{ b.id }}"
            data-color="{{ color }}"
            class="biz-tab inline-flex items-center gap-2 px-4 py-2 rounded-t-lg border text-sm font-medium
                   text-{{ color }}-700 border-{{ color }}-300 hover:bg-{{ color }}-100 hover:border-{{ color }}-600 hover:text-{{ color }}-900">
            {{ b.name }}
          </a>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <form method="post" class="space-y-5" autocomplete="off" id="orderForm"
        data-edit="{{ object|yesno:'1,0' }}"
        data-so-id="{{ object.id|default:'' }}"
        data-paid="{{ paid_so_far|default:'0.00' }}"
        data-default-payment="{{ default_sale_payment_method|default:'cash' }}">
    {% csrf_token %}
    {{ form.business }}

    <!-- Customer & Payment Section - Clean & Compact -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-3" id="customerSection">
      <!-- Main Row: Customer, Date, Payment Method, Bank (Adaptive) -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
        
        <!-- Customer Name -->
        <div class="md:col-span-4">
          <label class="block text-xs font-medium text-slate-700 mb-1">
            Customer Name
            <span id="customerBalanceBadge" class="ml-2 text-[10px] font-normal text-slate-500 hidden"></span>
          </label>
          <div class="relative">
            {{ form.customer_name }}
            {{ form.customer_name.errors }}
            <ul id="nameSuggest"
                class="absolute z-30 mt-1 w-full bg-white border border-slate-300 rounded-lg shadow-lg hidden max-h-48 overflow-auto"></ul>
            
            <div class="hidden">
              {{ form.customer }}
              {{ form.customer.errors }}
            </div>
          </div>
          <p class="text-[10px] text-slate-500 mt-1">Leave empty for Walk-in Customer</p>
        </div>

        <!-- Order Date -->
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-slate-700 mb-1">Order Date</label>
          {{ form.order_date }}
          {{ form.order_date.errors }}
        </div>

        <!-- Payment Method -->
        <div class="md:col-span-3">
          <label class="block text-xs font-medium text-slate-700 mb-1">Payment Method</label>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center gap-1.5 cursor-pointer group">
              <input type="radio" name="{{ form.receipt_method.name }}" value="cash"
                     class="w-3.5 h-3.5 text-blue-600 focus:ring-2 focus:ring-blue-500"
                     id="payment_cash" {% if default_sale_payment_method|default:'cash' == 'cash' %}checked{% endif %}>
              <span class="text-xs font-medium text-slate-700 group-hover:text-blue-600">Cash</span>
            </label>
            <label class="flex items-center gap-1.5 cursor-pointer group">
              <input type="radio" name="{{ form.receipt_method.name }}" value="bank"
                     class="w-3.5 h-3.5 text-blue-600 focus:ring-2 focus:ring-blue-500"
                     id="payment_bank">
              <span class="text-xs font-medium text-slate-700 group-hover:text-blue-600">Bank</span>
            </label>
            <label class="flex items-center gap-1.5 cursor-pointer group">
              <input type="radio" name="{{ form.receipt_method.name }}" value="card"
                     class="w-3.5 h-3.5 text-blue-600 focus:ring-2 focus:ring-blue-500"
                     id="payment_card">
              <span class="text-xs font-medium text-slate-700 group-hover:text-blue-600">Card</span>
            </label>
            <label class="flex items-center gap-1.5 cursor-pointer group">
              <input type="radio" name="{{ form.receipt_method.name }}" value="on_credit"
                     class="w-3.5 h-3.5 text-blue-600 focus:ring-2 focus:ring-blue-500"
                     id="payment_on_credit" {% if default_sale_payment_method|default:'cash' == 'on_credit' %}checked{% endif %}>
              <span class="text-xs font-medium text-slate-700 group-hover:text-blue-600">On Credit</span>
            </label>
          </div>
          {{ form.receipt_method.errors }}
        </div>

        <!-- Bank Account - Adaptive, appears in same row when bank or card is selected -->
        <div id="bankWrap" class="md:col-span-3 hidden">
          <label class="block text-xs font-medium text-slate-700 mb-1">Bank Account</label>
          {{ form.bank_account }}
          {{ form.bank_account.errors }}
        </div>
      </div>

      <!-- Previous Receipts - Full Width Below -->
      {% if previous_receipts %}
      <div class="mt-3 pt-3 border-t border-slate-200">
        <details class="rounded-lg border border-blue-200 bg-blue-50 p-2">
          <summary class="cursor-pointer text-xs font-semibold text-blue-800 hover:text-blue-900">Previous Receipts ({{ previous_receipts|length }})</summary>
          <ul class="mt-2 space-y-1 text-xs text-slate-600">
            {% for ap in previous_receipts %}
            <li class="flex justify-between items-center py-0.5">
              <span>{{ ap.payment.date }}</span>
              <span class="font-semibold text-slate-800">₨ {{ ap.amount|floatformat:2 }}</span>
              <span class="text-slate-500">
                {% if ap.payment.payment_source == 'bank' and ap.payment.bank_account %}
                  Bank: {{ ap.payment.bank_account.bank_name|default:ap.payment.bank_account.name }}
                {% else %}
                  Cash
                {% endif %}
              </span>
            </li>
            {% endfor %}
          </ul>
        </details>
      </div>
      {% endif %}
    </div>

    <!-- Quick Add Item Section - Clean & Prominent -->
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-300 shadow-md p-4 mb-4">
      {{ formset.management_form }}

      <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
        <!-- Barcode Input -->
        <div class="md:col-span-3">
          <label class="block text-xs font-semibold text-slate-700 mb-1.5">Barcode</label>
          <div class="relative">
            <input type="text" id="quickBarcode"
                   class="w-full rounded-lg border-2 border-blue-300 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                   placeholder="Scan or type barcode">
            <ul id="quickBarcodeSuggest"
                class="absolute z-30 mt-1 w-full bg-white border border-slate-300 rounded-lg shadow-lg hidden max-h-52 overflow-auto"></ul>
          </div>
        </div>

        <!-- Product Name -->
        <div class="md:col-span-3">
          <label class="block text-xs font-semibold text-slate-700 mb-1.5">Product Name</label>
          <div class="relative">
            <input type="text" id="quickProductSearch"
                   class="w-full rounded-lg border-2 border-blue-300 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                   placeholder="Search product...">
            <ul id="quickProductSuggest"
                class="absolute z-30 mt-1 w-full bg-white border border-slate-300 rounded-lg shadow-lg hidden max-h-60 overflow-auto"></ul>
          </div>
          <input type="hidden" id="quickProductId">
          <p id="quickStock" class="text-xs text-slate-600 mt-1 min-h-[16px]"></p>
          <span id="quickProductUnit" class="text-xs text-slate-600 mt-0.5 block"></span>
        </div>

        <!-- Unit Toggle -->
        <div class="md:col-span-1">
          <label class="block text-xs font-semibold text-slate-700 mb-1.5">Unit</label>
          <button type="button" id="quickUnitToggle"
                  class="w-full px-2 py-2.5 text-xs border-2 border-blue-300 rounded-lg hover:bg-blue-50 cursor-pointer text-center bg-white"
                  data-current-unit="lowest"
                  title="Click to toggle between units">
            <span id="quickUnitLabel">--</span>
          </button>
          <input type="hidden" id="quickUomId">
          <input type="hidden" id="quickSizePerUnit" value="1.000000">
        </div>

        <!-- Quantity -->
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold text-slate-700 mb-1.5">Quantity</label>
          <input type="number" id="quickQty"
                 class="w-full rounded-lg border-2 border-blue-300 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                 placeholder="1" step="0.01" min="0" value="1">
        </div>

        <!-- Price -->
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold text-slate-700 mb-1.5">Unit Price</label>
          <input type="number" id="quickPrice"
                 class="w-full rounded-lg border-2 border-blue-300 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                 placeholder="0.00" step="0.01" min="0">
        </div>

        <!-- Add Button -->
        <div class="md:col-span-1 flex items-end">
          <button type="button" id="quickAddBtn"
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2.5 text-sm font-semibold transition-all duration-150 flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            <span>Add</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Items Table -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-sm font-bold text-slate-800">Order Items</h3>
        <span class="text-xs text-slate-500 font-medium"><span id="itemCount">0</span> items</span>
      </div>

      <div class="overflow-x-auto">
        <div id="itemsScroll" style="max-height: 350px; overflow-y: auto;">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-700 text-white sticky top-0 z-10">
              <tr>
                <th class="px-3 py-2 text-left font-semibold w-8">#</th>
                <th class="px-3 py-2 text-left font-semibold">Product</th>
                <th class="px-3 py-2 text-center font-semibold w-16">Unit</th>
                <th class="px-3 py-2 text-center font-semibold w-20">Qty</th>
                <th class="px-3 py-2 text-right font-semibold w-24">Price</th>
                <th class="px-3 py-2 text-right font-semibold w-28">Total</th>
                <th class="px-3 py-2 text-center font-semibold w-16">Action</th>
              </tr>
            </thead>
            <tbody id="itemBody">
              {% for f in formset.forms %}
              <tr class="item-row border-b border-slate-100 hover:bg-slate-50 transition-colors">
                <td class="px-3 py-2 text-slate-500 font-medium row-number">1</td>
                
                <td class="px-3 py-2">
                  {{ f.id }}
                  <div class="hidden">
                    {{ f.uom }}
                    {{ f.size_per_unit }}
                  </div>
                  <div class="flex flex-col gap-0.5">
                    <div class="relative">
                      {{ f.product }}
                      <span class="prod-name font-medium text-slate-800"></span>
                      <span class="prod-barcode text-[10px] text-slate-500"></span>
                    </div>
                    {{ f.product.errors }}
                  </div>
                </td>

                <td class="px-3 py-2 text-center">
                  <span class="prod-unit text-xs font-semibold text-slate-600"></span>
                </td>

                <td class="px-3 py-2">
                  <div class="flex items-center justify-center">
                    {{ f.quantity }}
                  </div>
                  {{ f.quantity.errors }}
                </td>

                <td class="px-3 py-2">
                  <div class="flex items-center justify-end">
                    {{ f.unit_price }}
                  </div>
                  {{ f.unit_price.errors }}
                </td>

                <td class="px-3 py-2 text-right">
                  <span class="line-total font-bold text-slate-800">0.00</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <div class="hidden">
                    {{ f.DELETE }} 
                  </div>
                  {{ f.id }} <button type="button"
                          class="row-remove inline-flex items-center justify-center rounded-lg p-1.5 hover:bg-red-100 transition-colors group"
                          title="Remove">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600 group-hover:text-red-700"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                      <path d="M10 11v6"></path>
                      <path d="M14 11v6"></path>
                    </svg>
                  </button>
                </td>
                  </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Totals Section -->
      <div class="bg-slate-50 border-t border-slate-200 p-3">
        <div class="grid md:grid-cols-2 gap-3">
          <!-- Tax & Discount -->
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Tax %</label>
              {{ form.tax_percent }}
              {{ form.tax_percent.errors }}
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Discount %</label>
              {{ form.discount_percent }}
              {{ form.discount_percent.errors }}
            </div>
          </div>

          <!-- Summary -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between text-xs">
              <span class="font-medium text-slate-600">Subtotal</span>
              <span class="font-semibold text-slate-800">₨ <span id="subtotal">0.00</span></span>
            </div>
            <div class="flex items-center justify-between text-base font-bold text-white bg-blue-600 rounded-lg px-3 py-2 shadow-md">
              <span>Net Total</span>
              <span>₨ <span id="sum_net">0.00</span></span>
            </div>
          </div>
        </div>

        {% if object %}
        <div class="mt-3 border-2 border-amber-300 rounded-lg p-3 bg-amber-50">
          <div class="flex items-center justify-between text-xs mb-1.5">
            <span class="font-semibold text-slate-700">Paid So Far</span>
            <span class="font-bold text-emerald-600">₨ <span id="paid_so_far">0.00</span></span>
          </div>
          <div class="flex items-center justify-between text-sm font-bold text-amber-700">
            <span>Remaining Balance</span>
            <span class="text-base">₨ <span id="remaining_amt">0.00</span></span>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Bottom Action Bar -->
    <div class="sticky bottom-0 left-0 right-0 bg-white border-t-2 border-slate-200 shadow-lg rounded-t-xl">
      <div class="max-w-[1400px] mx-auto p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="w-full md:w-72">
          <label class="block text-xs font-semibold text-slate-700 mb-1">Amount Received</label>
          {{ form.received_amount }}
          {{ form.received_amount.errors }}
          <p class="text-[10px] text-slate-500 mt-0.5">Auto-filled for Cash/Bank/Card; 0 for On Credit</p>
        </div>

        <div class="flex flex-wrap justify-end gap-2">
          <a href="{% url 'so_add' %}?business={{ business.id }}"
             class="inline-flex items-center gap-1.5 rounded-lg px-4 py-2 border-2 border-slate-300 hover:bg-slate-100 font-semibold text-slate-700 transition-colors text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Reset
          </a>
          
          <button type="button" id="btnSilentPrint"
                  class="inline-flex items-center gap-1.5 rounded-lg px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold shadow-md hover:shadow-lg transition-all text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Print & Save
          </button>
          
          <button type="submit" id="btnSavePaid" name="action" value="close_paid"
                  class="inline-flex items-center gap-1.5 rounded-lg px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-md hover:shadow-lg transition-all text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Save Order
          </button>
        </div>
      </div>

      <input type="hidden" name="{{ form.status.name }}" id="id_status" value="{{ form.status.value|default:'open' }}">
    </div>

    {{ form.non_field_errors }}
    {% if form.errors %}
      <div class="rounded-lg border-2 border-red-300 bg-red-50 p-4 text-red-800 text-sm shadow-md">
        <strong class="font-bold">Form Errors:</strong> {{ form.errors }}
      </div>
    {% endif %}
    {% if formset.non_form_errors %}
      <div class="rounded-lg border-2 border-amber-300 bg-amber-50 p-4 text-amber-900 text-sm shadow-md">
        <strong class="font-bold">Items Errors:</strong> {{ formset.non_form_errors }}
      </div>
    {% endif %}
  </form>
</div>

<script>
(function () {
  function toNum(v) {
    const n = parseFloat((v || '').toString().replace(/,/g, ''));
    return isNaN(n) ? 0 : n;
  }
  function two(v) {
    return (parseFloat(v || 0) || 0).toFixed(2);
  }

  function showToast(message, type = 'info') {
    const existingToast = document.querySelector('.app-toast');
    if (existingToast) existingToast.remove();

    const colors = {
      info: 'bg-blue-600',
      warning: 'bg-amber-600',
      success: 'bg-emerald-600',
      error: 'bg-red-600'
    };
    
    // Enhanced background for success messages
    const bgColors = {
      info: 'bg-blue-600',
      warning: 'bg-amber-600',
      success: 'bg-emerald-500',  // Lighter green for better visibility
      error: 'bg-red-600'
    };

    const icons = {
      info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
      warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />',
      success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
      error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />'
    };

    const toast = document.createElement('div');
    toast.className = 'app-toast';
    const bgColor = bgColors[type] || colors[type];
    // Add extra styling for success messages
    const extraStyle = type === 'success' ? 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);' : '';
    toast.innerHTML = `
      <div style="position: fixed; top: 20px; right: 20px; z-index: 9999;
                  ${bgColor} color: white; padding: 16px 20px;
                  border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  animation: slideInRight 0.3s ease-out;
                  font-size: 14px; font-weight: 500; min-width: 300px; max-width: 500px; ${extraStyle}">
        <div style="display: flex; align-items: center; gap: 12px;">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            ${icons[type]}
          </svg>
          <div style="flex: 1;">${message}</div>
        </div>
      </div>
      <style>
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      </style>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function highlightRow(tr) {
    const originalBg = tr.style.backgroundColor;
    tr.style.transition = 'background-color 0.4s ease';
    tr.style.backgroundColor = '#fef3c7';
    
    setTimeout(() => {
      tr.style.backgroundColor = '#dbeafe';
    }, 200);
    
    setTimeout(() => {
      tr.style.backgroundColor = originalBg || '';
    }, 800);
  }

  (function ensureOrderDate() {
    const formEl = document.getElementById('orderForm');
    const isEdit = formEl?.dataset.edit === '1';
    const dateEl = document.getElementById('id_order_date');
    if (!dateEl || isEdit) return;
    const val = (dateEl.value || '').trim();
    if (val) return;

    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    dateEl.value = `${yyyy}-${mm}-${dd}`;
  })();

  function qProdInput(scope) {
    return scope.querySelector('select[name$="-product"], input[name$="-product"]');
  }
  
  function isBlankRow(tr) {
    const prodEl = qProdInput(tr);
    const q = tr.querySelector('input[name$="-quantity"]');
    const r = tr.querySelector('input[name$="-unit_price"]');
    
    // A row is blank if no product is selected AND quantity/price are zero or empty
    const prodEmpty = !(prodEl && prodEl.value);
    const qtyEmpty = !q || !q.value || toNum(q.value) === 0;
    const priceEmpty = !r || !r.value || toNum(r.value) === 0;
    
    return prodEmpty && qtyEmpty && priceEmpty;
  }

  const formEl = document.getElementById('orderForm');
  const isEdit = formEl?.dataset.edit === '1';
  const paidFromServer = toNum(formEl?.dataset.paid);

  const body = document.getElementById('itemBody');
  const itemsScroll = document.getElementById('itemsScroll');
  const totalEl = document.querySelector('[name$="TOTAL_FORMS"]');

  const taxEl = document.getElementById('id_tax_percent');
  const discEl = document.getElementById('id_discount_percent');

  const subtotalCell = document.getElementById('subtotal');
  const sumNet = document.getElementById('sum_net');

  const paidSoFarEl = document.getElementById('paid_so_far');
  const remainingEl = document.getElementById('remaining_amt');

  const businessInput = document.getElementById('id_business');

  const PRODUCT_STOCKS = {
    {% for p in products_cards %}
    "{{ p.id }}": {{ p.stock|default:'0' }},
    {% endfor %}
  };

  const PRODUCT_BY_BARCODE = {
    {% for p in products_cards %}
      {% if p.barcode %}
      "{{ p.barcode|escapejs }}": {
        id: "{{ p.id }}",
        name: "{{ p.name|escapejs }}",
        price: {{ p.sale_price|floatformat:2 }},
        stock: {{ p.stock|default:'0' }}
      },
      {% endif %}
    {% endfor %}
  };

  const PRODUCTS = [
    {% for p in products_cards %}
    {
      id: "{{ p.id }}",
      name: "{{ p.name|escapejs }}",
      price: {{ p.sale_price|floatformat:2 }},
      stock: {{ p.stock|default:'0' }}{% if p.barcode %},
      barcode: "{{ p.barcode|escapejs }}"{% else %},
      barcode: ""{% endif %},
      uom_id: "{{ p.uom_id|default:'' }}",
      uom_code: "{{ p.uom_code|escapejs }}",
      bulk_uom_id: "{{ p.bulk_uom_id|default:'' }}",
      bulk_uom_code: "{{ p.bulk_uom_code|escapejs }}",
      bulk_size: {{ p.bulk_size|default:'1' }},
      has_bulk: {{ p.has_bulk|yesno:"true,false" }}
    },
    {% endfor %}
  ];

  (function wireBusinessTabs() {
    const tabs = document.querySelectorAll('.biz-tab');
    if (!tabs.length) return;

    const base = ['inline-flex','items-center','gap-2','px-4','py-2','rounded-t-lg','border','text-sm','font-medium'];

    function inactiveClasses(color) {
      return [
        `text-${color}-700`,
        `border-${color}-300`,
        `hover:bg-${color}-100`,
        `hover:border-${color}-600`,
        `hover:text-${color}-900`,
      ];
    }

    function activeClasses(color) {
      return [
        `bg-${color}-700`,
        `border-${color}-700`,
        'text-white',
        'shadow-md',
      ];
    }

    function applyState(tab, isActive) {
      const color = tab.dataset.color || 'indigo';

      tab.classList.add(...base);

      // Remove all possible color classes
      ['indigo', 'emerald', 'rose', 'amber'].forEach(c => {
        tab.classList.remove(...inactiveClasses(c), ...activeClasses(c));
      });

      if (isActive) {
        tab.setAttribute('aria-current', 'page');
        tab.classList.add(...activeClasses(color));
      } else {
        tab.removeAttribute('aria-current');
        tab.classList.add(...inactiveClasses(color));
      }
    }

    // Initial state
    tabs.forEach(t => {
      const isActive = t.hasAttribute('aria-current') && t.getAttribute('aria-current') === 'page';
      applyState(t, isActive);
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', (e) => {
        // REMOVED e.preventDefault() to allow the browser to follow the link
        // and trigger a full page reload, ensuring server-side querysets
        // are correctly synchronized with the selected business.
        const bizId = tab.dataset.businessId;
        if (!bizId) return;

        if (businessInput) {
          businessInput.value = bizId;
        }
      });
    });
  })();

  (function autoSelectFirstBusiness() {
    const params = new URLSearchParams(window.location.search);
    const bizParam = params.get('business');
    
    if (!bizParam && businessInput && !businessInput.value) {
      const firstTab = document.querySelector('.biz-tab[data-business-id]');
      if (firstTab) {
        const firstBizId = firstTab.dataset.businessId;
        if (firstBizId) {
          businessInput.value = firstBizId;
          
          try {
            const url = new URL(window.location.href);
            url.searchParams.set('business', firstBizId);
            window.history.replaceState({}, '', url.toString());
          } catch (err) {}
        }
      }
    }
  })();

  const bankWrap = document.getElementById('bankWrap');
  const receiptMethodRadios = document.querySelectorAll('input[name="receipt_method"]');
  const amountReceivedInput = document.getElementById('id_received_amount');

  function applyReceiptEffects(net) {
    const selectedMethod = document.querySelector('input[name="receipt_method"]:checked')?.value;
    if (bankWrap) {
      // Show bank account field for bank and card payments only
      bankWrap.classList.toggle('hidden', !(selectedMethod === 'bank' || selectedMethod === 'card'));
    }
    if (!amountReceivedInput) return;
    const netVal = net != null ? net : toNum(sumNet?.textContent || 0);
    if (selectedMethod === 'on_credit') {
      amountReceivedInput.value = '0.00';
      amountReceivedInput.readOnly = true;
      amountReceivedInput.classList.add('receipt-on-credit');
    } else {
      amountReceivedInput.readOnly = false;
      amountReceivedInput.classList.remove('receipt-on-credit');
      if (selectedMethod === 'cash' || selectedMethod === 'bank' || selectedMethod === 'card') {
        amountReceivedInput.value = two(netVal);
      }
    }
  }

  // Auto-select default payment method from user preferences (Cash or On Credit)
  (function autoSelectDefaultPayment() {
    const defaultPayment = (formEl?.dataset?.defaultPayment || 'cash').toLowerCase();
    const targetId = defaultPayment === 'on_credit' ? 'payment_on_credit' : 'payment_cash';
    const targetRadio = document.getElementById(targetId);
    if (targetRadio && !targetRadio.checked) {
      targetRadio.checked = true;
      targetRadio.dispatchEvent(new Event('change', { bubbles: true }));
    }
  })();

  receiptMethodRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      applyReceiptEffects();
    });
  });

  const customerSelect = document.getElementById('id_customer');
  const nameInput = document.getElementById('id_customer_name');
  const nameSuggest = document.getElementById('nameSuggest');
  if (customerSelect) customerSelect.style.display = 'none';

  const people = [];
  if (customerSelect) {
    Array.from(customerSelect.options).forEach((opt) => {
      if (!opt.value) return;
      people.push({ id: opt.value, label: (opt.textContent || '').trim() });
    });
  }

  if (isEdit && nameInput && customerSelect && !nameInput.value && customerSelect.value) {
    const opt = Array.from(customerSelect.options).find((o) => o.value === customerSelect.value);
    if (opt) {
      nameInput.value = (opt.textContent || '').trim();
    }
  }

  function showCustomerBalance(data) {
    const badge = document.getElementById('customerBalanceBadge');
    if (!badge) return;
    
    // Hide badge if no customer selected or no data
    if (!data || !data.ok || !customerSelect || !customerSelect.value) {
      badge.classList.add('hidden');
      return;
    }

    const amount = data.amount || '0.00';
    const side = data.side || '';
    
    // Meaning from API or calculated here
    // Prompt: Red for Debit (they owe us) and Green for Credit (we owe them).
    
    let textColor = 'text-slate-500';
    let text = '';

    if (side === 'Dr') {
      // Debit = They owe us (Receivable)
      textColor = 'text-red-600 font-bold'; 
      text = `(They Owe: ₨ ${amount})`;
    } else if (side === 'Cr') {
      // Credit = We owe them (Payable/Advance)
      textColor = 'text-emerald-600 font-bold';
      text = `(We Owe: ₨ ${amount})`;
    } else {
      textColor = 'text-slate-500';
      text = `(Balance: ₨ ${amount})`;
    }

    badge.textContent = text;
    badge.className = `ml-2 text-xs ${textColor}`;
    badge.classList.remove('hidden');
  }

  async function loadCustomerBalance() {
    if (!customerSelect) return;
    const cid = customerSelect.value;
    if (!cid) return;

    const params = new URLSearchParams();
    params.append('party_id', cid);
    
    // Edit Sync: Exclude current Order ID to show "Previous Balance"
    const soId = formEl?.dataset?.soId;
    if (soId) {
      params.append('exclude_id', soId);
      params.append('exclude_type', 'sales_order');
    }

    // Note: We do NOT append business_id here because we want the Unified Global Balance 
    // across all businesses/roles.

    try {
      const resp = await fetch("{% url 'party_balance_base_api' %}?" + params.toString(), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
      });
      if (!resp.ok) return;
      const data = await resp.json();
      showCustomerBalance(data);
    } catch (err) {
      console.error('Failed to load customer balance', err);
      const badge = document.getElementById('customerBalanceBadge');
      if (badge) badge.classList.add('hidden');
    }
  }

  if (customerSelect) {
    customerSelect.addEventListener('change', loadCustomerBalance);
  }
  
  // Clear balance badge when customer name is cleared
  if (nameInput) {
    nameInput.addEventListener('input', function() {
      if (!this.value.trim()) {
        customerSelect.value = '';
        const badge = document.getElementById('customerBalanceBadge');
        if (badge) badge.classList.add('hidden');
      }
    });
  }

  let nameActiveIndex = -1;
  let nameCurrentItems = [];

  function updateNameActive() {
    const lis = nameSuggest.querySelectorAll('li');
    lis.forEach((li, idx) => {
      li.classList.toggle('bg-blue-100', idx === nameActiveIndex);
    });
  }

  function renderNameSuggest(items) {
    nameCurrentItems = items;
    nameActiveIndex = -1;
    nameSuggest.innerHTML = '';
    if (!items.length) {
      nameSuggest.classList.add('hidden');
      return;
    }
    items.slice(0, 30).forEach((it, idx) => {
      const li = document.createElement('li');
      li.className = 'px-4 py-2.5 hover:bg-slate-50 cursor-pointer text-sm';
      li.dataset.index = String(idx);
      li.textContent = it.label;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        nameInput.value = it.label;
        if (customerSelect) {
          customerSelect.value = it.id;
          customerSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
        nameSuggest.classList.add('hidden');
      });
      nameSuggest.appendChild(li);
    });
    nameSuggest.classList.remove('hidden');
    updateNameActive();
  }

  nameInput?.addEventListener('input', () => {
    const q = (nameInput.value || '').toLowerCase().trim();
    if (!q) {
      if (customerSelect) {
        customerSelect.value = '';
        customerSelect.dispatchEvent(new Event('change', { bubbles: true }));
      }
      nameSuggest.classList.add('hidden');
      return;
    }
    const matches = people.filter((p) => p.label.toLowerCase().includes(q));
    renderNameSuggest(matches);
  });

  nameInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Tab' && !e.shiftKey) {
      e.preventDefault();
      nameSuggest.classList.add('hidden');
      document.getElementById('quickBarcode')?.focus();
      return;
    }

    if (nameSuggest.classList.contains('hidden')) return;
    if (!nameCurrentItems.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      nameActiveIndex = (nameActiveIndex < nameCurrentItems.length - 1) ? nameActiveIndex + 1 : 0;
      updateNameActive();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      nameActiveIndex = (nameActiveIndex > 0) ? nameActiveIndex - 1 : nameCurrentItems.length - 1;
      updateNameActive();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (nameActiveIndex >= 0) {
        const it = nameCurrentItems[nameActiveIndex];
        nameInput.value = it.label;
        if (customerSelect) {
          customerSelect.value = it.id;
          customerSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
        nameSuggest.classList.add('hidden');
      }
    } else if (e.key === 'Escape') {
      nameSuggest.classList.add('hidden');
    }
  });

  document.addEventListener('click', (e) => {
    if (!nameSuggest.contains(e.target) && e.target !== nameInput) {
      nameSuggest.classList.add('hidden');
    }
  });

  function updateLineTotal(tr) {
    const qtyInp = tr.querySelector('input[name$="-quantity"]');
    const rateInp = tr.querySelector('input[name$="-unit_price"]');
    const qty = toNum(qtyInp?.value);
    const rate = toNum(rateInp?.value);
    const total = qty * rate;
    const cell = tr.querySelector('.line-total');
    if (cell) cell.textContent = two(total);
    return total;
  }

  function updateItemCount() {
    const visibleRows = Array.from(body.querySelectorAll('tr.item-row')).filter(tr => {
      if (tr.style.display === 'none') return false;
      const del = tr.querySelector('input[name$="-DELETE"]');
      if (del && del.checked) return false;
      return !isBlankRow(tr);
    });
    
    const countEl = document.getElementById('itemCount');
    if (countEl) countEl.textContent = visibleRows.length;
    
    // Update row numbers
    visibleRows.forEach((tr, idx) => {
      const numCell = tr.querySelector('.row-number');
      if (numCell) numCell.textContent = idx + 1;
    });
  }

  function computeTotals() {
    let subtotal = 0;
    body.querySelectorAll('tr.item-row').forEach((tr) => {
      if (tr.style.display === 'none') return;
      const del = tr.querySelector('input[name$="-DELETE"]');
      if (del && del.checked) return;
      if (isBlankRow(tr)) {
        const c = tr.querySelector('.line-total');
        if (c) c.textContent = '0.00';
        return;
      }
      subtotal += updateLineTotal(tr);
    });

    const taxPct = toNum(taxEl?.value);
    const discPct = toNum(discEl?.value);
    const taxAmt = subtotal * (taxPct / 100);
    const discAmt = subtotal * (discPct / 100);
    const net = subtotal + taxAmt - discAmt;

    if (subtotalCell) subtotalCell.textContent = two(subtotal);
    if (sumNet) sumNet.textContent = two(net);

    if (paidSoFarEl) {
      paidSoFarEl.textContent = two(paidFromServer);
    }
    if (remainingEl) {
      remainingEl.textContent = two(Math.max(0, net - paidFromServer));
    }

    updateItemCount();
    applyReceiptEffects(net);
  }

  function bumpTotalForms(delta) {
    if (!totalEl) return;
    const n = (parseInt(totalEl.value, 10) || 0) + delta;
    totalEl.value = n < 0 ? 0 : n;
    const rows = Array.from(body.querySelectorAll('tr.item-row')).filter((r) => r.style.display !== 'none');
    rows.forEach((tr, idx) => {
      tr.querySelectorAll('input, select').forEach((el) => {
        if (!el.name) return;
        el.name = el.name.replace(/-(\d+)-/, `-${idx}-`);
        if (el.id) el.id = el.id.replace(/-(\d+)-/, `-${idx}-`);
      });
    });
  }

  function clearRow(tr) {
    tr.querySelectorAll('input, select').forEach((el) => {
      if (!el.name) return;
      if (el.tagName === 'SELECT' || (el.tagName === 'INPUT' && el.type === 'hidden')) el.value = '';
      else if (el.type === 'checkbox') el.checked = false;
      else el.value = '';
    });
    const lt = tr.querySelector('span.line-total');
    if (lt) lt.textContent = '0.00';
    const nameSpan = tr.querySelector('.prod-name');
    if (nameSpan) nameSpan.textContent = '';
    const barcodeSpan = tr.querySelector('.prod-barcode');
    if (barcodeSpan) barcodeSpan.textContent = '';
    const unitSpan = tr.querySelector('.prod-unit');
    if (unitSpan) unitSpan.textContent = '';
  }

  function findExistingProductRow(productId) {
    if (!productId) return null;
    
    const rows = Array.from(body.querySelectorAll('tr.item-row'));
    for (const row of rows) {
      if (row.style.display === 'none') continue;
      
      const delInput = row.querySelector('input[name$="-DELETE"]');
      if (delInput && delInput.checked) continue;
      
      const prodEl = qProdInput(row);
      if (prodEl && prodEl.value === productId) {
        return row;
      }
    }
    return null;
  }

  function focusOnExistingProduct(existingRow, productName) {
    const qtyInput = existingRow.querySelector('input[name$="-quantity"]');
    
    if (qtyInput) {
      existingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      highlightRow(existingRow);
      
      setTimeout(() => {
        qtyInput.focus();
        qtyInput.select();
      }, 300);
      
      showToast(`${productName} is already in the list. Quantity updated!`, 'warning');
    }
  }

  function addProductToTable(productInfo, qty, price, isScannerInput = false) {
    // Check stock before adding
    const stock = toNum(productInfo.stock || 0);
    if (stock <= 0) {
      showToast(`Cannot add ${productInfo.name}: Stock is zero or unavailable`, 'error');
      return;
    }

    // Check if requested quantity exceeds stock
    const requestedQty = toNum(qty || 0);
    if (requestedQty > stock) {
      showToast(`${productInfo.name}: Only ${two(stock)} available in stock. You requested ${two(requestedQty)}.`, 'error');
      return;
    }

    // Check for duplicate
    const existingRow = findExistingProductRow(productInfo.id);
    
    if (existingRow) {
      // Check total quantity after adding
      const qtyInput = existingRow.querySelector('input[name$="-quantity"]');
      if (qtyInput) {
        const currentQty = toNum(qtyInput.value);
        const newTotalQty = currentQty + requestedQty;
        
        if (newTotalQty > stock) {
          showToast(`${productInfo.name}: Only ${two(stock)} available. Current: ${two(currentQty)}, Requested: ${two(requestedQty)}`, 'error');
          return;
        }
        
        qtyInput.value = two(newTotalQty);
      }
      focusOnExistingProduct(existingRow, productInfo.name);
      computeTotals();
      return;
    }

    // Find first blank row or create new
    let targetRow = null;
    const rows = Array.from(body.querySelectorAll('tr.item-row'));
    
    for (const row of rows) {
      if (row.style.display === 'none') continue;
      const del = row.querySelector('input[name$="-DELETE"]');
      if (del && del.checked) continue;
      
      if (isBlankRow(row)) {
        targetRow = row;
        break;
      }
    }

    if (!targetRow) {
      // Create new row
      const lastRow = body.querySelector('tr.item-row:last-child');
      if (lastRow) {
        targetRow = lastRow.cloneNode(true);
        targetRow.style.display = '';
        clearRow(targetRow);
        body.appendChild(targetRow);
        bumpTotalForms(+1);
        wireRow(targetRow);
      }
    }

    if (targetRow) {
      const prodSelect = qProdInput(targetRow);
      const qtyInput = targetRow.querySelector('input[name$="-quantity"]');
      const priceInput = targetRow.querySelector('input[name$="-unit_price"]');
      const uomInput = targetRow.querySelector('input[name$="-uom"]');
      const sizeInput = targetRow.querySelector('input[name$="-size_per_unit"]');
      const nameSpan = targetRow.querySelector('.prod-name');
      const barcodeSpan = targetRow.querySelector('.prod-barcode');
      const unitSpan = targetRow.querySelector('.prod-unit');

      if (prodSelect) {
        prodSelect.value = productInfo.id;
        
        // Use selected unit from productInfo (from quick add toggle) or default to lower unit
        const fullProductInfo = PRODUCTS.find(p => p.id === productInfo.id);
        if (fullProductInfo && uomInput && sizeInput) {
          // Check if productInfo has unit info from quick add toggle
          if (productInfo.size_per_unit && productInfo.uom_id) {
            // Use the unit from quick add toggle
            uomInput.value = productInfo.uom_id;
            sizeInput.value = productInfo.size_per_unit || '1.000000';
            
            // Display unit code from productInfo
            if (unitSpan && productInfo.uom_code) {
              unitSpan.textContent = productInfo.uom_code;
            }
          } else {
            // Default to base UOM (lower unit)
            if (fullProductInfo.uom_id) {
              uomInput.value = fullProductInfo.uom_id;
            }
            sizeInput.value = '1.000000';
            
            // Display unit code
            if (unitSpan && fullProductInfo.uom_code) {
              unitSpan.textContent = fullProductInfo.uom_code;
            }
          }
        }
      }
      if (qtyInput) qtyInput.value = two(qty);
      if (priceInput) priceInput.value = two(price);
      if (nameSpan) nameSpan.textContent = productInfo.name;
      if (barcodeSpan && productInfo.barcode) {
        barcodeSpan.textContent = `Barcode: ${productInfo.barcode}`;
      }
      // Set unit display (use productInfo.uom_code if available, otherwise fallback)
      if (unitSpan) {
        if (productInfo.uom_code) {
          unitSpan.textContent = productInfo.uom_code;
        } else if (fullProductInfo && fullProductInfo.uom_code) {
          unitSpan.textContent = fullProductInfo.uom_code;
        }
      }

      computeTotals();
      if (!isScannerInput) {
        showToast(`${productInfo.name} added successfully!`, 'success');
      }
    }
  }

  // Quick Add Section
  const quickBarcode = document.getElementById('quickBarcode');
  const quickProductSearch = document.getElementById('quickProductSearch');
  const quickProductId = document.getElementById('quickProductId');
  const quickQty = document.getElementById('quickQty');
  const quickPrice = document.getElementById('quickPrice');
  const quickStock = document.getElementById('quickStock');
  const quickAddBtn = document.getElementById('quickAddBtn');

  const quickBarcodeSuggest = document.getElementById('quickBarcodeSuggest');
  const quickProductSuggest = document.getElementById('quickProductSuggest');

  let quickBarcodeItems = [];
  let quickBarcodeActiveIndex = -1;

  let quickProductItems = [];
  let quickProductActiveIndex = -1;

  // Barcode scanner detection
  let barcodeInputTimer = null;
  let lastBarcodeInputTime = 0;
  let barcodeInputValue = '';
  const BARCODE_SCANNER_THRESHOLD = 50; // milliseconds between keystrokes indicates scanner

  function clearQuickForm() {
    quickBarcode.value = '';
    quickProductSearch.value = '';
    quickProductId.value = '';
    quickQty.value = '1';
    quickPrice.value = '';
    quickStock.textContent = '';
    const quickProductUnit = document.getElementById('quickProductUnit');
    const quickUnitLabel = document.getElementById('quickUnitLabel');
    const quickUomId = document.getElementById('quickUomId');
    const quickSizePerUnit = document.getElementById('quickSizePerUnit');
    const quickUnitToggle = document.getElementById('quickUnitToggle');
    if (quickProductUnit) quickProductUnit.textContent = '';
    if (quickUnitLabel) quickUnitLabel.textContent = '--';
    if (quickUomId) quickUomId.value = '';
    if (quickSizePerUnit) quickSizePerUnit.value = '1.000000';
    if (quickUnitToggle) {
      quickUnitToggle.dataset.currentUnit = 'lowest';
      quickUnitToggle.disabled = true;
      quickUnitToggle.classList.add('opacity-50', 'cursor-not-allowed');
    }
    quickBarcodeSuggest.classList.add('hidden');
    quickProductSuggest.classList.add('hidden');
    // Focus back on barcode field after clearing (use setTimeout to ensure it works)
    setTimeout(() => {
      quickBarcode?.focus();
    }, 50);
  }

  function updateQuickBarcodeActive() {
    const lis = quickBarcodeSuggest.querySelectorAll('li');
    lis.forEach((li, idx) => {
      li.classList.toggle('bg-blue-100', idx === quickBarcodeActiveIndex);
    });
  }

  function renderQuickBarcodeSuggest(items) {
    quickBarcodeItems = items;
    quickBarcodeActiveIndex = -1;
    quickBarcodeSuggest.innerHTML = '';
    if (!items.length) {
      quickBarcodeSuggest.classList.add('hidden');
      return;
    }
    items.forEach((it, idx) => {
      const li = document.createElement('li');
      li.dataset.index = String(idx);
      li.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer text-sm';
      li.innerHTML = `
        <div class="font-semibold">${it.barcode}</div>
        <div class="text-xs text-slate-600">${it.name} (Stock: ${two(it.stock)})</div>
      `;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        applyQuickProduct(it);
      });
      quickBarcodeSuggest.appendChild(li);
    });
    quickBarcodeSuggest.classList.remove('hidden');
    updateQuickBarcodeActive();
  }

  function updateQuickProductActive() {
    const lis = quickProductSuggest.querySelectorAll('li');
    lis.forEach((li, idx) => {
      li.classList.toggle('bg-blue-100', idx === quickProductActiveIndex);
    });
  }

  function renderQuickProductSuggest(items) {
    quickProductItems = items;
    quickProductActiveIndex = -1;
    quickProductSuggest.innerHTML = '';
    if (!items.length) {
      quickProductSuggest.classList.add('hidden');
      return;
    }
    items.forEach((it, idx) => {
      const li = document.createElement('li');
      li.dataset.index = String(idx);
      li.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer text-sm';
      
      const stockColor = it.stock > 0 ? 'text-emerald-600' : 'text-red-600';
      li.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-semibold">${it.name}</span>
          <span class="text-xs ${stockColor} font-bold">Stock: ${two(it.stock)}</span>
        </div>
        ${it.barcode ? `<div class="text-xs text-slate-500">Barcode: ${it.barcode}</div>` : ''}
      `;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        applyQuickProduct(it);
      });
      quickProductSuggest.appendChild(li);
    });
    quickProductSuggest.classList.remove('hidden');
    updateQuickProductActive();
  }

  function handleBarcodeScan(barcode) {
    // Find product by barcode
    let productInfo = PRODUCTS.find(p => p.barcode === barcode);
    
    if (!productInfo && PRODUCT_BY_BARCODE[barcode]) {
      const barcodeInfo = PRODUCT_BY_BARCODE[barcode];
      const fullProduct = PRODUCTS.find(p => p.id === barcodeInfo.id);
      productInfo = {
        id: barcodeInfo.id,
        name: barcodeInfo.name,
        barcode: barcode,
        price: barcodeInfo.price,
        stock: barcodeInfo.stock,
        uom_id: fullProduct?.uom_id || '',
        uom_code: fullProduct?.uom_code || '',
        bulk_uom_id: fullProduct?.bulk_uom_id || '',
        bulk_uom_code: fullProduct?.bulk_uom_code || '',
        bulk_size: fullProduct?.bulk_size || '1',
        has_bulk: fullProduct?.has_bulk || false,
      };
    }

    if (!productInfo) {
      showToast('No product found for this barcode', 'error');
      quickBarcode.value = '';
      quickBarcode.focus();
      return;
    }

    // Check stock before adding
    const stock = toNum(productInfo.stock || 0);
    if (stock <= 0) {
      showToast(`Cannot add ${productInfo.name}: Stock is zero or unavailable`, 'error');
      quickBarcode.value = '';
      quickBarcode.focus();
      return;
    }

    // Check if product already exists in table
    const existingRow = findExistingProductRow(productInfo.id);
    if (existingRow) {
      // Increment quantity by 1, but check stock first
      const qtyInput = existingRow.querySelector('input[name$="-quantity"]');
      if (qtyInput) {
        const currentQty = toNum(qtyInput.value);
        const newQty = currentQty + 1;
        
        if (newQty > stock) {
          showToast(`${productInfo.name}: Only ${two(stock)} available. Current: ${two(currentQty)}`, 'error');
          quickBarcode.value = '';
          quickBarcode.focus();
          return;
        }
        
        qtyInput.value = two(newQty);
        qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
        computeTotals();
        highlightRow(existingRow);
        showToast(`${productInfo.name} quantity increased to ${qtyInput.value}`, 'success');
      }
    } else {
      // Add new item with quantity 1, auto-select base UOM
      addProductToTable(productInfo, 1, productInfo.price, true);
    }

    // Clear barcode input and reset scanner detection
    quickBarcode.value = '';
    quickBarcode.dataset.isScanner = 'false';
    quickBarcode.focus();
  }

  function applyQuickProduct(info) {
    quickBarcode.value = info.barcode || '';
    quickProductSearch.value = info.name;
    quickProductId.value = info.id;
    
    // Set up unit display and toggle - default to lower unit (not bulk)
    const quickProductUnit = document.getElementById('quickProductUnit');
    const quickUnitToggle = document.getElementById('quickUnitToggle');
    const quickUnitLabel = document.getElementById('quickUnitLabel');
    const quickUomId = document.getElementById('quickUomId');
    const quickSizePerUnit = document.getElementById('quickSizePerUnit');
    
    // Always default to lower unit in sales order
    if (quickUnitLabel) quickUnitLabel.textContent = info.uom_code || '--';
    if (quickUomId) quickUomId.value = info.uom_id || '';
    if (quickSizePerUnit) quickSizePerUnit.value = '1.000000';
    if (quickUnitToggle) {
      quickUnitToggle.dataset.currentUnit = 'lowest';
      quickUnitToggle.dataset.lowestUomId = info.uom_id || '';
      quickUnitToggle.dataset.lowestUomCode = info.uom_code || '';
      quickUnitToggle.dataset.bulkUomId = info.bulk_uom_id || '';
      quickUnitToggle.dataset.bulkUomCode = info.bulk_uom_code || '';
      quickUnitToggle.dataset.bulkSize = info.bulk_size || '1';
      quickUnitToggle.dataset.lowerUnitPrice = info.price || '0';
      
      // Enable toggle if bulk unit exists
      if (info.bulk_uom_id && info.bulk_size) {
        quickUnitToggle.disabled = false;
        quickUnitToggle.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        quickUnitToggle.disabled = true;
        quickUnitToggle.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
    if (quickProductUnit) quickProductUnit.textContent = `Unit: ${info.uom_code || ''}`;
    
    // Set price to lower unit price (default)
    quickPrice.value = two(info.price || 0);
    
    const stock = toNum(info.stock || 0);
    if (stock <= 0) {
      quickStock.textContent = `⚠️ Stock: ${two(stock)} (Cannot add - Out of stock)`;
      quickStock.className = 'text-xs text-red-600 mt-1 font-bold';
    } else {
      // Display stock in both lower and bulk units
      let stockText = `Stock: ${two(stock)} ${info.uom_code || ''}`;
      if (info.has_bulk && info.bulk_size && info.bulk_size > 0 && info.bulk_uom_code) {
        const bulkStock = stock / toNum(info.bulk_size);
        stockText += ` / ${two(bulkStock)} ${info.bulk_uom_code}`;
      }
      quickStock.textContent = stockText;
      quickStock.className = 'text-xs text-emerald-600 mt-1 font-semibold';
    }
    
    quickBarcodeSuggest.classList.add('hidden');
    quickProductSuggest.classList.add('hidden');
    
    quickQty.focus();
    quickQty.select();
  }

  quickBarcode.addEventListener('keydown', (e) => {
    const now = Date.now();
    const timeSinceLastKey = now - lastBarcodeInputTime;
    lastBarcodeInputTime = now;

    // Detect scanner: very fast input (less than 50ms between keys usually indicates scanner)
    const isLikelyScanner = timeSinceLastKey > 0 && timeSinceLastKey < BARCODE_SCANNER_THRESHOLD;

    // Store that this might be scanner input
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
      quickBarcode.dataset.isScanner = isLikelyScanner ? 'true' : 'false';
    }
  });

  quickBarcode.addEventListener('input', () => {
    const q = (quickBarcode.value || '').trim().toLowerCase();
    if (!q) {
      quickBarcodeSuggest.classList.add('hidden');
      return;
    }
    
    // Clear any pending timer
    if (barcodeInputTimer) {
      clearTimeout(barcodeInputTimer);
    }

    // For manual typing, show suggestions
    if (quickBarcode.dataset.isScanner !== 'true') {
      const matches = PRODUCTS.filter(p => p.barcode && p.barcode.toLowerCase().includes(q)).slice(0, 20);
      renderQuickBarcodeSuggest(matches);
    } else {
      // For scanner input, wait for input to complete (no typing for 100ms)
      barcodeInputTimer = setTimeout(() => {
        const finalCode = (quickBarcode.value || '').trim();
        if (finalCode) {
          handleBarcodeScan(finalCode);
        }
      }, 100);
    }
  });

  quickBarcode.addEventListener('keydown', (e) => {
    const hasList = !quickBarcodeSuggest.classList.contains('hidden') && quickBarcodeItems.length > 0;

    if (e.key === 'ArrowDown' && hasList) {
      e.preventDefault();
      quickBarcodeActiveIndex = (quickBarcodeActiveIndex < quickBarcodeItems.length - 1) ? quickBarcodeActiveIndex + 1 : 0;
      updateQuickBarcodeActive();
      return;
    }
    
    if (e.key === 'ArrowUp' && hasList) {
      e.preventDefault();
      quickBarcodeActiveIndex = (quickBarcodeActiveIndex > 0) ? quickBarcodeActiveIndex - 1 : quickBarcodeItems.length - 1;
      updateQuickBarcodeActive();
      return;
    }
    
    if (e.key === 'Enter') {
      e.preventDefault();

      // If it's likely scanner input, handle it immediately
      if (quickBarcode.dataset.isScanner === 'true') {
        const code = (quickBarcode.value || '').trim();
        if (code) {
          handleBarcodeScan(code);
          return;
        }
      }

      if (hasList && quickBarcodeActiveIndex >= 0) {
        applyQuickProduct(quickBarcodeItems[quickBarcodeActiveIndex]);
        return;
      }

      const code = (quickBarcode.value || '').trim();
      if (!code) {
        quickProductSearch.focus();
        return;
      }

      let direct = PRODUCTS.find(p => p.barcode === code);
      if (!direct && PRODUCT_BY_BARCODE[code]) {
        const barcodeInfo = PRODUCT_BY_BARCODE[code];
        const fullProduct = PRODUCTS.find(p => p.id === barcodeInfo.id);
        direct = {
          id: barcodeInfo.id,
          name: barcodeInfo.name,
          barcode: code,
          price: barcodeInfo.price,
          stock: barcodeInfo.stock,
          uom_id: fullProduct?.uom_id || '',
          uom_code: fullProduct?.uom_code || '',
          bulk_uom_id: fullProduct?.bulk_uom_id || '',
          bulk_uom_code: fullProduct?.bulk_uom_code || '',
          bulk_size: fullProduct?.bulk_size || '1',
          has_bulk: fullProduct?.has_bulk || false,
        };
      }

      if (!direct) {
        showToast('No product found for this barcode', 'error');
        quickBarcode.select();
        return;
      }
      
      applyQuickProduct(direct);
      return;
    }
    
    if (e.key === 'Escape' && hasList) {
      e.preventDefault();
      quickBarcodeSuggest.classList.add('hidden');
    }
    
    if (e.key === 'Tab' && !e.shiftKey) {
      quickBarcodeSuggest.classList.add('hidden');
    }
  });

  quickProductSearch.addEventListener('input', () => {
    const q = (quickProductSearch.value || '').trim().toLowerCase();
    if (!q) {
      quickProductSuggest.classList.add('hidden');
      quickProductId.value = '';
      quickPrice.value = '';
      quickStock.textContent = '';
      return;
    }
    const matches = PRODUCTS.filter(p => p.name.toLowerCase().includes(q)).slice(0, 30);
    renderQuickProductSuggest(matches);
  });

  quickProductSearch.addEventListener('keydown', (e) => {
    const hasList = !quickProductSuggest.classList.contains('hidden') && quickProductItems.length > 0;

    if (e.key === 'ArrowDown' && hasList) {
      e.preventDefault();
      quickProductActiveIndex = (quickProductActiveIndex < quickProductItems.length - 1) ? quickProductActiveIndex + 1 : 0;
      updateQuickProductActive();
      return;
    }
    
    if (e.key === 'ArrowUp' && hasList) {
      e.preventDefault();
      quickProductActiveIndex = (quickProductActiveIndex > 0) ? quickProductActiveIndex - 1 : quickProductItems.length - 1;
      updateQuickProductActive();
      return;
    }
    
    if (e.key === 'Enter') {
      e.preventDefault();
      if (hasList && quickProductActiveIndex >= 0) {
        applyQuickProduct(quickProductItems[quickProductActiveIndex]);
        return;
      }
      if (quickProductItems.length === 1) {
        applyQuickProduct(quickProductItems[0]);
        return;
      }
      quickQty.focus();
    }
    
    if (e.key === 'Escape' && hasList) {
      e.preventDefault();
      quickProductSuggest.classList.add('hidden');
    }
  });

  quickQty.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      quickPrice.focus();
      quickPrice.select();
    }
  });

  quickPrice.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      quickAddBtn.click();
    }
  });

  // Quick unit toggle handler - auto-calculates bulk price
  const quickUnitToggle = document.getElementById('quickUnitToggle');
  const quickUomId = document.getElementById('quickUomId');
  const quickSizePerUnit = document.getElementById('quickSizePerUnit');
  
  if (quickUnitToggle) {
    quickUnitToggle.addEventListener('click', function() {
      const currentUnit = this.dataset.currentUnit;
      const lowestUomId = this.dataset.lowestUomId;
      const lowestUomCode = this.dataset.lowestUomCode;
      const bulkUomId = this.dataset.bulkUomId;
      const bulkUomCode = this.dataset.bulkUomCode;
      const bulkSize = this.dataset.bulkSize;
      const lowerUnitPrice = this.dataset.lowerUnitPrice;
      const quickUnitLabel = document.getElementById('quickUnitLabel');
      const quickProductUnit = document.getElementById('quickProductUnit');
      
      if (!bulkUomId) return; // No bulk unit available
      
      if (currentUnit === 'lowest') {
        // Switch to bulk - auto-calculate bulk price
        this.dataset.currentUnit = 'bulk';
        if (quickUnitLabel) quickUnitLabel.textContent = bulkUomCode;
        if (quickUomId) quickUomId.value = bulkUomId;
        if (quickSizePerUnit) quickSizePerUnit.value = bulkSize;
        if (quickProductUnit) quickProductUnit.textContent = `Unit: ${bulkUomCode}`;
        
        // Auto-calculate bulk price: lower_unit_price * bulk_size
        const lowerPrice = toNum(lowerUnitPrice || quickPrice.value);
        const bulkSizeNum = toNum(bulkSize);
        if (bulkSizeNum > 0 && lowerPrice > 0) {
          const bulkPrice = lowerPrice * bulkSizeNum;
          quickPrice.value = two(bulkPrice);
        }
      } else {
        // Switch to lowest - restore lower unit price
        this.dataset.currentUnit = 'lowest';
        if (quickUnitLabel) quickUnitLabel.textContent = lowestUomCode;
        if (quickUomId) quickUomId.value = lowestUomId;
        if (quickSizePerUnit) quickSizePerUnit.value = '1.000000';
        if (quickProductUnit) quickProductUnit.textContent = `Unit: ${lowestUomCode}`;
        
        // Restore lower unit price
        if (lowerUnitPrice) {
          quickPrice.value = two(lowerUnitPrice);
        }
      }
    });
  }

  quickAddBtn.addEventListener('click', () => {
    const productId = quickProductId.value;
    const qty = toNum(quickQty.value);
    const price = toNum(quickPrice.value);
    const selectedUomId = quickUomId ? quickUomId.value : null;
    const selectedSizePerUnit = quickSizePerUnit ? toNum(quickSizePerUnit.value) : 1;

    if (!productId) {
      showToast('Please select a product', 'warning');
      quickProductSearch.focus();
      return;
    }

    if (!qty || qty <= 0) {
      showToast('Please enter a valid quantity', 'warning');
      quickQty.focus();
      return;
    }

    if (!price || price <= 0) {
      showToast('Please enter a valid price', 'warning');
      quickPrice.focus();
      return;
    }

    const productInfo = PRODUCTS.find(p => p.id === productId);
    if (!productInfo) {
      showToast('Product not found', 'error');
      return;
    }
    
    // Override productInfo with selected unit
    const productInfoWithUnit = {
      ...productInfo,
      uom_id: selectedUomId || productInfo.uom_id,
      uom_code: quickUnitToggle && quickUnitToggle.dataset.currentUnit === 'bulk' 
        ? productInfo.bulk_uom_code 
        : productInfo.uom_code,
      size_per_unit: selectedSizePerUnit,
      price: price // Use the price from input (may be bulk price if bulk unit selected)
    };

    // Check stock before adding - convert to base unit for stock check
    const stock = toNum(productInfo.stock || 0);
    if (stock <= 0) {
      showToast(`Cannot add ${productInfo.name}: Stock is zero or unavailable`, 'error');
      quickProductSearch.focus();
      return;
    }

    // Convert requested quantity to base unit for stock check
    const requestedQtyInBaseUnit = qty * selectedSizePerUnit;
    if (requestedQtyInBaseUnit > stock) {
      showToast(`${productInfo.name}: Only ${two(stock)} ${productInfo.uom_code} available in stock. You requested ${two(qty)} ${productInfoWithUnit.uom_code} (${two(requestedQtyInBaseUnit)} ${productInfo.uom_code}).`, 'error');
      quickQty.focus();
      quickQty.select();
      return;
    }

    addProductToTable(productInfoWithUnit, qty, price, false);
    clearQuickForm();
  });

  document.addEventListener('click', (e) => {
    if (!quickBarcodeSuggest.contains(e.target) && e.target !== quickBarcode) {
      quickBarcodeSuggest.classList.add('hidden');
    }
    if (!quickProductSuggest.contains(e.target) && e.target !== quickProductSearch) {
      quickProductSuggest.classList.add('hidden');
    }
  });

  function wireRow(tr) {
    // Wire up qty and price inputs to update totals
    const qtyInput = tr.querySelector('input[name$="-quantity"]');
    const priceInput = tr.querySelector('input[name$="-unit_price"]');
    const prodSelect = qProdInput(tr);
    
    if (qtyInput) {
      qtyInput.addEventListener('input', () => {
        // Validate stock when quantity changes
        if (prodSelect && prodSelect.value) {
          const productInfo = PRODUCTS.find(p => p.id === prodSelect.value);
          if (productInfo) {
            const stock = toNum(productInfo.stock || 0);
            const requestedQty = toNum(qtyInput.value || 0);
            
            if (stock <= 0) {
              showToast(`${productInfo.name}: Stock is zero`, 'error');
              qtyInput.value = '0';
            } else if (requestedQty > stock) {
              showToast(`${productInfo.name}: Only ${two(stock)} available. You entered ${two(requestedQty)}`, 'error');
              qtyInput.value = two(stock);
            }
          }
        }
        updateLineTotal(tr);
        computeTotals();
      });
    }
    
    if (priceInput) {
      priceInput.addEventListener('input', () => {
        updateLineTotal(tr);
        computeTotals();
      });
    }
    
    // Update unit display when product changes
    if (prodSelect) {
      prodSelect.addEventListener('change', function() {
        const productId = this.value;
        const unitSpan = tr.querySelector('.prod-unit');
        const nameSpan = tr.querySelector('.prod-name');
        const barcodeSpan = tr.querySelector('.prod-barcode');
        
        if (productId) {
          const productInfo = PRODUCTS.find(p => p.id === productId);
          if (productInfo) {
            if (unitSpan) {
              unitSpan.textContent = productInfo.uom_code || '';
            }
            if (nameSpan) {
              nameSpan.textContent = productInfo.name || '';
            }
            if (barcodeSpan) {
              barcodeSpan.textContent = productInfo.barcode ? `Barcode: ${productInfo.barcode}` : '';
            }
            
            // Check stock and show warning if zero
            const stock = toNum(productInfo.stock || 0);
            if (stock <= 0) {
              showToast(`${productInfo.name}: Stock is zero or unavailable`, 'error');
              // Clear quantity if stock is zero
              if (qtyInput) {
                qtyInput.value = '0';
              }
            }
          }
        } else {
          if (unitSpan) unitSpan.textContent = '';
          if (nameSpan) nameSpan.textContent = '';
          if (barcodeSpan) barcodeSpan.textContent = '';
        }
      });
    }

    tr.querySelector('.row-remove')?.addEventListener('click', () => {
      // 1. Check if this is an existing row (has an ID) or a new row
      const idInput = tr.querySelector('input[name$="-id"]');
      const deleteCheckbox = tr.querySelector('input[name$="-DELETE"]');
      
      // 2. Count visible rows to ensure at least one remains (UX recommendation)
      const visibleRows = Array.from(body.querySelectorAll('tr.item-row'))
                              .filter(r => r.style.display !== 'none').length;
      
      if (visibleRows <= 1) {
        showToast("Cannot delete the last item. An order must have at least one product.", "error");
        return;
      }

      if (!idInput || !idInput.value) {
        // It's a new, unsaved row -> just remove it and update total forms
        tr.remove();
        bumpTotalForms(-1);
      } else {
        // It's an existing row -> mark for deletion and hide
        if (deleteCheckbox) {
          deleteCheckbox.checked = true; // THIS IS CRITICAL
          tr.style.display = 'none';    // Hide visually
          tr.classList.add('marked-for-delete'); // Optional helper class
        }
      }
      
      // 3. Recalculate totals immediately
      computeTotals();
      showToast("Item marked for removal. Save the order to update stock.", "info");
    });
  }
  (function initializeRows() {
    const rows = Array.from(body.querySelectorAll('tr.item-row'));
    rows.forEach((tr, idx) => {
      wireRow(tr);
      
      // Update row number
      const numCell = tr.querySelector('.row-number');
      if (numCell) numCell.textContent = idx + 1;
      
      // Set product name, barcode, and unit from existing data
      const prodEl = qProdInput(tr);
      if (prodEl && prodEl.value) {
        const selectedOpt = prodEl.options[prodEl.selectedIndex];
        const nameSpan = tr.querySelector('.prod-name');
        const barcodeSpan = tr.querySelector('.prod-barcode');
        const unitSpan = tr.querySelector('.prod-unit');
        
        if (selectedOpt) {
          if (nameSpan) nameSpan.textContent = (selectedOpt.textContent || '').trim();
          
          const productInfo = PRODUCTS.find(p => p.id === prodEl.value);
          if (productInfo) {
            if (barcodeSpan && productInfo.barcode) {
              barcodeSpan.textContent = `Barcode: ${productInfo.barcode}`;
            }
            if (unitSpan && productInfo.uom_code) {
              unitSpan.textContent = productInfo.uom_code;
            }
          }
        }
      }
      
      // Add product change handler to update unit display
      const prodSelect = qProdInput(tr);
      if (prodSelect) {
        prodSelect.addEventListener('change', function() {
          const productId = this.value;
          const unitSpan = tr.querySelector('.prod-unit');
          if (productId && unitSpan) {
            const productInfo = PRODUCTS.find(p => p.id === productId);
            if (productInfo && productInfo.uom_code) {
              unitSpan.textContent = productInfo.uom_code;
            } else {
              unitSpan.textContent = '';
            }
          }
        });
      }
      
      const price = tr.querySelector('input[name$="-unit_price"]');
      if (price) {
        const v = (price.value || '').trim();
        if (v === '0' || v === '0.0' || v === '0.00' || v === '0.0000') {
          price.value = '';
        }
      }
    });

    computeTotals();
    
    // Auto-focus on barcode field on page load
    if (quickBarcode) {
      // Use setTimeout to ensure DOM is fully ready and no other code steals focus
      setTimeout(() => {
        quickBarcode.focus();
      }, 100);
    }
  })();

  let isSubmitting = false;

  formEl?.addEventListener('submit', (e) => {
    if (isSubmitting) {
      e.preventDefault();
      return;
    }
    isSubmitting = true;

    const rows = Array.from(body.querySelectorAll('tr.item-row')).filter((tr) => tr.style.display !== 'none');
    let nonBlankCount = 0;
    rows.forEach((tr) => {
      const del = tr.querySelector('input[name$="-DELETE"]');
      if (isBlankRow(tr)) {
        if (del) {
          del.checked = true;
          // Important: remove required attribute if present to bypass browser validation
          tr.querySelectorAll('input, select').forEach(el => el.removeAttribute('required'));
        }
      } else {
        nonBlankCount++;
      }
    });
    if (nonBlankCount === 0 && rows.length) {
      const firstDel = rows[0].querySelector('input[name$="-DELETE"]');
      if (firstDel) firstDel.checked = false;
    }

    const btnSavePaid = document.getElementById('btnSavePaid');
    const active = document.activeElement;
    const isSaveButtonActive = active && active.id === 'btnSavePaid';
    if (btnSavePaid && (isSaveButtonActive || !active || active.tagName !== 'BUTTON')) {
      if (!btnSavePaid.dataset.originalText) {
        btnSavePaid.dataset.originalText = btnSavePaid.textContent;
      }
      btnSavePaid.innerHTML = `
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Processing...</span>
      `;
      btnSavePaid.classList.add('opacity-70', 'cursor-not-allowed', 'pointer-events-none');
    }
  });

  taxEl?.addEventListener('input', computeTotals);
  discEl?.addEventListener('input', computeTotals);

  // Auto-focus on barcode field on page load
  function focusInitial() {
    // Always focus on barcode field first for quick item entry
    if (quickBarcode) {
      setTimeout(() => {
        quickBarcode.focus();
      }, 100);
    }
  }
  // Use multiple methods to ensure focus happens
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', focusInitial);
  } else {
    requestAnimationFrame(focusInitial);
    setTimeout(focusInitial, 200); // Backup in case animation frame doesn't work
  }

  if (customerSelect && customerSelect.value) {
    loadCustomerBalance();
  }

  function getCsrfToken() {
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  function showSuccessMessage(message) {
    const existingMsg = document.querySelector('.success-message-overlay');
    if (existingMsg) existingMsg.remove();

    const msgDiv = document.createElement('div');
    msgDiv.className = 'success-message-overlay';
    msgDiv.innerHTML = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;
                  background: linear-gradient(135deg, #10b981, #059669);
                  color: white; padding: 32px 48px;
                  border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  animation: scaleIn 0.3s ease-out;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
          <svg style="width: 64px; height: 64px;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 24px; margin-bottom: 8px;">${message}</div>
            <div style="font-size: 16px; opacity: 0.9;">Receipt printed successfully</div>
          </div>
        </div>
      </div>
      <style>
        @keyframes scaleIn {
          from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
          to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes scaleOut {
          from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          to { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
      </style>
    `;
    document.body.appendChild(msgDiv);

    setTimeout(() => {
      msgDiv.style.animation = 'scaleOut 0.3s ease-in';
      setTimeout(() => msgDiv.remove(), 300);
    }, 2000);
  }

  const btnSilent = document.getElementById('btnSilentPrint');
  btnSilent?.addEventListener('click', async () => {
    if (btnSilent.disabled) return;
    btnSilent.disabled = true;
    const originalHTML = btnSilent.innerHTML;
    btnSilent.innerHTML = `
      <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Printing...</span>
    `;

    try {
      const form = document.getElementById('orderForm');
      if (!form) return;

      const receivedAmountInput = document.getElementById('id_received_amount');
      const receivedAmount = toNum(receivedAmountInput?.value || 0);
      const netTotal = toNum(sumNet?.textContent || 0);

      const totalPaid = paidFromServer + receivedAmount;
      const remainingAmount = Math.max(0, netTotal - totalPaid);

      const fd = new FormData(form);
      fd.set('received_amount', two(receivedAmount));
      fd.set('remaining_amount', two(remainingAmount));
      fd.set('paid_so_far', two(paidFromServer));
      fd.set('action', 'close_paid');

      if (businessInput) {
        fd.set('business', businessInput.value || '');
      }

      {% if object %}
      fd.set('id', '{{ object.id }}');
      {% endif %}

      {% if request.user.username %}
      fd.set('username', '{{ request.user.username }}');
      {% elif request.user.get_full_name %}
      fd.set('username', '{{ request.user.get_full_name }}');
      {% endif %}

      const bizId = (businessInput && businessInput.value) ? businessInput.value : '{{ business.id }}';
      const url = `{% url 'pos_save_and_print' %}?business=${encodeURIComponent(bizId)}&width_kind=80mm`;

      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrfToken(),
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: fd,
      });

      const text = await resp.text();
      let data = null;
      try {
        data = JSON.parse(text);
      } catch (err) {
        console.error('Response was not JSON:', text);
        throw new Error('Server returned HTML, not JSON. Check the backend view.');
      }

      if (!resp.ok || !data.ok) {
        throw new Error(data?.error || 'Save or print failed');
      }

      showSuccessMessage(`Order #${data.order_id} saved!`);

      setTimeout(() => {
        window.location.href = `{% url 'so_add' %}?business=${encodeURIComponent(bizId)}`;
      }, 2000);

    } catch (e) {
      console.error('Print error:', e);
      showToast('Error: ' + (e?.message || e), 'error');
      btnSilent.innerHTML = originalHTML;
      btnSilent.disabled = false;
    }
  });

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      const btn = document.getElementById('btnSilentPrint');
      if (btn && !btn.disabled) {
        btn.click();
      }
    }
  });
})();
</script>

<style>
/* Custom styles for form elements */
#id_customer_name,
#id_order_date,
#id_bank_account,
#id_received_amount {
  width: 100%;
  padding: 0.5rem 0.625rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  transition: all 0.2s;
}

#id_customer_name:focus,
#id_order_date:focus,
#id_bank_account:focus,
#id_received_amount:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#id_received_amount.receipt-on-credit {
  background-color: #f1f5f9;
  cursor: not-allowed;
}

/* Customer section inputs - clean and compact */
#customerSection input,
#customerSection select {
  padding: 0.5rem 0.75rem !important;
  font-size: 0.875rem !important;
  line-height: 1.25rem !important;
}

#id_tax_percent,
#id_discount_percent {
  width: 100%;
  padding: 0.5rem 0.625rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  transition: all 0.2s;
}

#id_tax_percent:focus,
#id_discount_percent:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Item table input styles */
.item-row select[name$="-product"] {
  display: none;
}

.item-row input[name$="-quantity"],
.item-row input[name$="-unit_price"] {
  width: 100%;
  padding: 0.375rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  text-align: center;
  transition: all 0.2s;
}

.item-row input[name$="-unit_price"] {
  text-align: right;
}

.item-row input[name$="-quantity"]:focus,
.item-row input[name$="-unit_price"]:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Autocomplete list styles */
#nameSuggest li,
#quickBarcodeSuggest li,
#quickProductSuggest li {
  transition: background-color 0.15s;
  font-size: 0.75rem;
  padding: 0.5rem 0.75rem;
}

/* Scrollbar styles */
#itemsScroll::-webkit-scrollbar {
  width: 6px;
}

#itemsScroll::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

#itemsScroll::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

#itemsScroll::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Animation for spinner */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Product name display in table */
.prod-name {
  display: block;
  font-size: 0.75rem;
  line-height: 1rem;
}

.prod-barcode {
  display: block;
  margin-top: 0.125rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .item-row input[name$="-quantity"],
  .item-row input[name$="-unit_price"] {
    font-size: 0.7rem;
    padding: 0.3rem;
  }
}
</style>
{% endblock %}